<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Absence Management | NGU-hrs</title>
    <!-- EMAILJS SDK -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <style>
        /* (all the CSS you already have – unchanged) */
        * { margin:0; padding:0; box-sizing:border-box; }
        body { font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;
               background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
               min-height:100vh; padding:20px; }
        .container { max-width:1400px; margin:0 auto; }
        header { background:rgba(255,255,255,0.95); padding:25px 30px;
                 border-radius:15px; box-shadow:0 10px 30px rgba(0,0,0,0.2);
                 margin-bottom:30px; display:flex; justify-content:space-between;
                 align-items:center; }
        .header-left h1 { color:#667eea; font-size:2.2em; font-weight:700; }
        .header-left p { color:#666; margin-top:5px; }
        .back-btn { background:linear-gradient(135deg,#667eea,#764ba2);
                    color:white; padding:12px 25px; border:none; border-radius:8px;
                    cursor:pointer; font-size:1em; transition:transform .2s;
                    text-decoration:none; display:inline-block; }
        .back-btn:hover { transform:translateY(-2px);
                          box-shadow:0 5px 15px rgba(0,0,0,0.2); }
        /* … (rest of your CSS – unchanged) … */
    </style>
</head>
<body>
    <div class="container">
        <!-- (all your HTML – unchanged) -->
        <!-- … -->
    </div>

    <script src="employees.js"></script>

    <script>
        let selectedEmployeeId = null;
        let allRecords = [];

        // ────────────────────── EMAIL CONFIG ──────────────────────
        const EMAILJS_SERVICE_ID = 'service_9dr2ws7';
        const EMAILJS_TEMPLATE_ID = 'template_cpujhfa';
        const EMAILJS_PUBLIC_KEY = 'ziLnha91scpGjFABh';

        // NEW: list of managers that receive the absence notification
        const MANAGERS = [
            'barry.dixon@next-gen.uk',
            'Marie.Wall@next-gen.uk',
            'Carl.Finnigan@next-gen.uk',
            'ashleigh.ginks@next-gen.uk',
            'Maia.foster@next-gen.uk',
            'Rebecca.Salter@next-gen.uk'
        ];

        emailjs.init(EMAILJS_PUBLIC_KEY);

        // ────────────────────── 1. Add New Employee ──────────────────────
        function addNewEmployee() {
            const name = prompt("Enter employee name:");
            if (!name || name.trim() === "") return alert("Name is required");

            const emp = EMPLOYEES.add(name.trim());
            alert(`Added: ${emp.name} (ID: ${emp.id})`);
            renderEmployeeList();
            selectEmployee(emp.id);
        }

        // ────────────────────── 2. INIT ──────────────────────
        function initEmployees() {
            EMPLOYEES.init();
            EMPLOYEES.data.forEach(emp => {
                if (!emp.absences) emp.absences = [];
                if (!emp.holidayRemaining) emp.holidayRemaining = 25;
                if (!emp.holidayTaken) emp.holidayTaken = 0;
                if (!emp.absenceDays) emp.absenceDays = 0;
            });
            EMPLOYEES.save();
            renderEmployeeList();
        }

        // ────────────────────── 3. Render Employee List ──────────────────────
        function renderEmployeeList() {
            const container = document.getElementById('employeeListContainer');
            container.innerHTML = '';
            EMPLOYEES.data.forEach(emp => {
                const item = document.createElement('div');
                item.className = 'employee-item';
                item.onclick = () => selectEmployee(emp.id);
                item.innerHTML = `<strong>${emp.name}</strong><span>ID: ${emp.id}</span>`;
                container.appendChild(item);
            });
        }

        // ────────────────────── 4. Select Employee ──────────────────────
        function selectEmployee(id) {
            selectedEmployeeId = id;
            const emp = EMPLOYEES.data.find(e => e.id === id);
            if (!emp) return;

            document.querySelectorAll('.employee-item').forEach(i => i.classList.remove('active'));
            document.querySelector(`.employee-item[onclick="selectEmployee('${id}')"]`)?.classList.add('active');

            document.getElementById('noSelection').style.display = 'none';
            document.getElementById('employeeAbsence').style.display = 'block';
            document.getElementById('employeeName').textContent = emp.name;
            document.getElementById('employeeId').textContent = 'ID: ' + emp.id;

            loadAbsenceData(emp);
        }

        // ────────────────────── 5. Load & Display Absence Data ──────────────────────
        function loadAbsenceData(emp) {
            const records = emp.absences || [];
            allRecords = [...records];

            const sicknessHours = records.filter(r => r.type === 'sickness').reduce((s, r) => s + parseFloat(r.hours), 0);
            const sicknessDays = Math.ceil(sicknessHours / 8);
            const aaupCount = records.filter(r => r.type === 'aaup').length;
            const tofdCount = records.filter(r => r.type === 'tofd').length;

            document.getElementById('sicknessDays').textContent = sicknessDays;
            document.getElementById('sicknessHours').textContent = sicknessHours;
            document.getElementById('aaupCount').textContent = aaupCount;
            document.getElementById('tofdCount').textContent = tofdCount;
            document.getElementById('totalIncidents').textContent = records.length;

            document.getElementById('empSicknessIncidents').textContent = records.filter(r => r.type === 'sickness').length;
            document.getElementById('empAaupIncidents').textContent = records.filter(r => r.type === 'aaup').length;
            document.getElementById('empTofdIncidents').textContent = records.filter(r => r.type === 'tofd').length;
            document.getElementById('empGrandTotalIncidents').textContent = records.length;

            document.getElementById('filterType').value = 'all';
            document.getElementById('filterMonth').value = '';

            displayAbsenceRecords(records);
        }

        function displayAbsenceRecords(records) {
            const container = document.getElementById('absenceHistory');
            if (!records.length) {
                container.innerHTML = '<p style="color:#666;text-align:center;padding:40px;">No absence records found</p>';
                return;
            }
            const labels = { sickness: 'Sickness', aaup: 'AAUP', tofd: 'TOFD' };
            let html = '';
            records.forEach(r => {
                html += `
                    <div class="absence-record ${r.type}">
                        <div class="record-header">
                            <span class="record-type">${labels[r.type]}</span>
                            <span class="record-dates">${formatDate(r.dateFrom)} - ${formatDate(r.dateTo)}</span>
                        </div>
                        <div class="record-details">
                            <div class="record-detail-item"><strong>Hours:</strong> ${r.hours}</div>
                            <div class="record-detail-item"><strong>Days:</strong> ${Math.ceil(r.hours / 8)}</div>
                        </div>
                        ${r.notes ? `<div class="record-notes">Note: ${r.notes}</div>` : ''}
                    </div>`;
            });
            container.innerHTML = html;
        }

        // ────────────────────── 6. Filters ──────────────────────
        function filterAbsences() {
            const type = document.getElementById('filterType').value;
            const month = document.getElementById('filterMonth').value;
            let filtered = [...allRecords];
            if (type !== 'all') filtered = filtered.filter(r => r.type === type);
            if (month) filtered = filtered.filter(r => r.dateFrom.substring(0, 7) === month);
            updateFilteredStats(filtered);
            displayAbsenceRecords(filtered);
        }

        function updateFilteredStats(records) {
            const sicknessHours = records.filter(r => r.type === 'sickness').reduce((s, r) => s + parseFloat(r.hours), 0);
            const sicknessDays = Math.ceil(sicknessHours / 8);
            const aaup = records.filter(r => r.type === 'aaup').length;
            const tofd = records.filter(r => r.type === 'tofd').length;
            document.getElementById('sicknessDays').textContent = sicknessDays;
            document.getElementById('sicknessHours').textContent = sicknessHours;
            document.getElementById('aaupCount').textContent = aaup;
            document.getElementById('tofdCount').textContent = tofd;
            document.getElementById('totalIncidents').textContent = records.length;
        }

        function formatDate(str) {
            const d = new Date(str);
            return d.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
        }

        // ────────────────────── 7. Search ──────────────────────
        function filterEmployees() {
            const term = document.getElementById('searchInput').value.toLowerCase();
            document.querySelectorAll('.employee-item').forEach(item => {
                const text = item.textContent.toLowerCase();
                item.style.display = text.includes(term) ? 'block' : 'none';
            });
        }

        // ────────────────────── 8. Submit Absence + EMAIL TO ALL MANAGERS ──────────────────────
        document.getElementById('absenceForm').addEventListener('submit', function (e) {
            e.preventDefault();
            if (!selectedEmployeeId) return alert('Select an employee first');

            const emp = EMPLOYEES.data.find(e => e.id === selectedEmployeeId);
            const typeLabel = document.getElementById('absenceType').options[document.getElementById('absenceType').selectedIndex].text;

            const rec = {
                type: document.getElementById('absenceType').value,
                dateFrom: document.getElementById('dateFrom').value,
                dateTo: document.getElementById('dateTo').value,
                hours: parseFloat(document.getElementById('hours').value),
                notes: document.getElementById('notes').value,
                submittedAt: new Date().toLocaleString()
            };

            emp.absences.push(rec);
            if (rec.type === 'sickness') {
                emp.absenceDays = (emp.absenceDays || 0) + Math.ceil(rec.hours / 8);
            }
            EMPLOYEES.save();

            // ── SEND ONE EMAIL TO EVERY MANAGER ──
            // ── SEND EMAIL WITH FULL SUMMARY ──
const templateParams = {
    employee_name: emp.name,
    employee_id: emp.id,
    type: typeLabel,
    date_from: rec.dateFrom,
    date_to: rec.dateTo,
    hours: rec.hours,
    notes: rec.notes || '—',
    submitted_at: rec.submittedAt,

    // NEW: Add current totals
    total_sick_days: Math.ceil(
        emp.absences
            .filter(r => r.type === 'sickness')
            .reduce((s, r) => s + parseFloat(r.hours), 0) / 8
    ),
    total_sickness_incidents: emp.absences.filter(r => r.type === 'sickness').length,
    total_aaup_incidents: emp.absences.filter(r => r.type === 'aaup').length,
    total_tofd_incidents: emp.absences.filter(r => r.type === 'tofd').length
};

const sendPromises = MANAGERS.map(email => {
    return emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, {
        ...templateParams,
        to_email: email
    });
});

Promise.all(sendPromises)
    .then(() => {
        alert(`Absence saved & emailed to ${MANAGERS.length} managers!`);
    })
    .catch(err => {
        console.error('Email error:', err);
        alert('Absence saved, but one or more emails failed. Check console.');
    });

            this.reset();
            loadAbsenceData(emp);
        });

        document.getElementById('dateFrom').addEventListener('change', function () {
            document.getElementById('dateTo').setAttribute('min', this.value);
        });

        // ────────────────────── 9. Export ──────────────────────
        function showExportModal() { document.getElementById('exportModal').classList.add('active'); }
        function closeExportModal() {
            document.getElementById('exportModal').classList.remove('active');
            document.getElementById('exportForm').reset();
        }

        document.getElementById('exportForm').addEventListener('submit', function (e) {
            e.preventDefault();
            const type = document.getElementById('exportType').value;
            const month = document.getElementById('exportMonth').value;

            let records = [];
            EMPLOYEES.data.forEach(emp => {
                (emp.absences || []).forEach(r => {
                    records.push({ employeeId: emp.id, employeeName: emp.name, ...r });
                });
            });

            if (type !== 'all') records = records.filter(r => r.type === type);
            if (month) records = records.filter(r => r.dateFrom.substring(0, 7) === month);

            exportToCSV(records, type, month);
            closeExportModal();
        });

        function exportToCSV(records, typeFilter, monthFilter) {
            if (!records.length) return alert('No records to export');

            const totalSickness = records.filter(r => r.type === 'sickness').length;
            const totalAaup = records.filter(r => r.type === 'aaup').length;
            const totalTofd = records.filter(r => r.type === 'tofd').length;
            const grandTotal = records.length;

            let csv = `,,,"Summary Totals",,,,\n`;
            csv += `,,,"Sickness Incidents","${totalSickness}",,,\n`;
            csv += `,,,"AAUP Incidents","${totalAaup}",,,\n`;
            csv += `,,,"TOFD Incidents","${totalTofd}",,,\n`;
            csv += `,,,"Grand Total","${grandTotal}",,,\n\n`;
            csv += 'Employee ID,Employee Name,Absence Type,Date From,Date To,Hours,Days,Notes\n';

            records.forEach(r => {
                const days = Math.ceil(r.hours / 8);
                const notes = (r.notes || '').replace(/"/g, '""');
                csv += `"${r.employeeId}","${r.employeeName}","${r.type}","${r.dateFrom}","${r.dateTo}",${r.hours},${days},"${notes}"\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            const fn = `absence_export_${typeFilter !== 'all' ? typeFilter + '_' : ''}${monthFilter ? monthFilter + '_' : ''}${new Date().toISOString().split('T')[0]}.csv`;
            link.href = url;
            link.download = fn;
            link.click();
            alert(`Exported ${records.length} record(s)`);
        }

        document.getElementById('exportModal').addEventListener('click', e => {
            if (e.target === e.currentTarget) closeExportModal();
        });

        // ────────────────────── 10. ON LOAD ──────────────────────
        window.onload = function () {
            initEmployees();
            document.getElementById('empSicknessIncidents').textContent = '—';
            document.getElementById('empAaupIncidents').textContent = '—';
            document.getElementById('empTofdIncidents').textContent = '—';
            document.getElementById('empGrandTotalIncidents').textContent = '—';
        };
    </script>
</body>
</html>
