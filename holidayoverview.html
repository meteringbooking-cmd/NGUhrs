<script>
    /* --------------------------------------------------------------
       1. GLOBAL STATE
    -------------------------------------------------------------- */
    let selectedEmployeeId = null;
    let allRecords = [];
    let currentEditIndex = -1;

    const EMAILJS_SERVICE_ID = 'service_9dr2ws7';
    const EMAILJS_TEMPLATE_ID = 'template_cpujhfa';
    const EMAILJS_PUBLIC_KEY = 'ziLnha91scpGjFABh';
    const MANAGERS = [
        'barry.dixon@next-gen.uk','Marie.Wall@next-gen.uk','Carl.Finnigan@next-gen.uk',
        'ashleigh.ginks@next-gen.uk','Maia.foster@next-gen.uk','Rebecca.Salter@next-gen.uk'
    ];
    emailjs.init(EMAILJS_PUBLIC_KEY);

    /* --------------------------------------------------------------
       2. HELPERS – auto-approve past holidays
    -------------------------------------------------------------- */
    const TODAY = new Date(); TODAY.setHours(0,0,0,0);
    const isHolidayInPast = r => {
        const end = new Date(r.dateTo); end.setHours(0,0,0,0);
        return end < TODAY;
    };
    const effectiveStatus = r => isHolidayInPast(r) ? 'approved' : r.status;

    /* --------------------------------------------------------------
       3. RENDER EMPLOYEE LIST
    -------------------------------------------------------------- */
    function renderEmployeeList() {
        const container = document.getElementById('employeeListContainer');
        const showActive = document.getElementById('showActive').checked;
        const showLeavers = document.getElementById('showLeavers').checked;

        if (!EMPLOYEES || !EMPLOYEES.data || !Array.isArray(EMPLOYEES.data)) {
            container.innerHTML = '<p style="color:#666; text-align:center;">Loading employees...</p>';
            return;
        }

        const active = EMPLOYEES.data.filter(e => !e.dateLeft);
        const leavers = EMPLOYEES.data.filter(e => e.dateLeft);
        document.getElementById('activeCount').textContent = active.length;
        document.getElementById('leaverCount').textContent = leavers.length;

        let toShow = [];
        if (showActive && showLeavers) toShow = EMPLOYEES.data;
        else if (showActive) toShow = active;
        else if (showLeavers) toShow = leavers;

        if (!toShow.length) {
            container.innerHTML = '<p style="color:#666; text-align:center;">No employees to show</p>';
            return;
        }

        container.innerHTML = '';
        toShow.forEach(emp => {
            const div = document.createElement('div');
            div.className = `employee-item ${emp.dateLeft ? 'leaver' : ''}`;
            div.onclick = () => selectEmployee(emp.id);
            div.innerHTML = `<strong>${emp.name}</strong><span>ID: ${emp.id}</span>`;
            container.appendChild(div);
        });
    }

    /* --------------------------------------------------------------
       4. SELECT EMPLOYEE
    -------------------------------------------------------------- */
    function selectEmployee(id) {
        selectedEmployeeId = id;
        const emp = EMPLOYEES.data.find(e => e.id === id);
        if (!emp) return;

        document.querySelectorAll('.employee-item').forEach(i => i.classList.remove('active'));
        const el = document.querySelector(`.employee-item[onclick="selectEmployee('${id}')"]`);
        if (el) el.classList.add('active');

        document.getElementById('noSelection').style.display = 'none';
        document.getElementById('employeeHoliday').style.display = 'block';
        document.getElementById('employeeName').textContent = emp.name;
        document.getElementById('employeeId').textContent = 'ID: ' + emp.id;

        loadHolidayData(emp);
    }

    /* --------------------------------------------------------------
       5. LOAD & DISPLAY HOLIDAY DATA
    -------------------------------------------------------------- */
    function loadHolidayData(emp) {
        const records = emp.holidays || [];
        allRecords = [...records];

        const total = emp.holidayEntitlement || 28;
        const taken = records.filter(r => effectiveStatus(r) === 'approved')
                             .reduce((s,r)=>s+parseFloat(r.days),0);
        const requested = records.filter(r => effectiveStatus(r) === 'pending')
                                 .reduce((s,r)=>s+parseFloat(r.days),0);
        const remaining = total - taken - requested;

        document.getElementById('totalEntitlement').textContent = total;
        document.getElementById('daysTaken').textContent = taken;
        document.getElementById('daysRequested').textContent = requested;
        document.getElementById('daysRemaining').textContent = remaining;

        document.getElementById('filterStatus').value = 'all';
        document.getElementById('filterMonth').value = '';

        displayHolidayRecords(records);
    }

    function displayHolidayRecords(records) {
        const container = document.getElementById('holidayHistory');
        if (!records.length) {
            container.innerHTML = '<p style="color:#666;text-align:center;padding:40px;">No holiday records found</p>';
            return;
        }

        const labels = {approved:'Approved',pending:'Pending',rejected:'Rejected'};
        const classes = {approved:'status-approved',pending:'status-pending',rejected:'status-rejected'};

        let html = '';
        records.forEach((r, i) => {
            const eff = effectiveStatus(r);
            const auto = (r.status==='pending' && eff==='approved') ? ' <small style="opacity:.7">(Auto-Approved)</small>' : '';
            html += `
                <div class="holiday-record ${eff}">
                    <div class="record-main">
                        <div class="record-header">
                            <span class="record-type">${r.type||'Full Day'}</span>
                            <span class="record-status ${classes[eff]}">${labels[eff]}${auto}</span>
                        </div>
                        <div class="record-dates">${formatDate(r.dateFrom)} - ${formatDate(r.dateTo)}</div>
                        <div class="record-details">
                            <div class="record-detail-item"><strong>Days:</strong> ${r.days}</div>
                        </div>
                        ${r.notes?`<div class="record-notes">${r.notes}</div>`:''}
                    </div>
                    <div class="record-actions">
                        <button class="edit-btn" onclick="openEditModal(${i})" title="Edit">Edit</button>
                        <button class="delete-btn" onclick="deleteRecord(${i})" title="Delete">Delete</button>
                    </div>
                </div>`;
        });
        container.innerHTML = html;
    }

    /* --------------------------------------------------------------
       6. EDIT / DELETE / EMAIL
    -------------------------------------------------------------- */
    function openEditModal(idx) { /* ... same as before ... */ }
    function closeEditModal() { document.getElementById('editModal').classList.remove('active'); currentEditIndex = -1; }
    async function saveEdit() { /* ... same ... */ }
    async function deleteRecord(idx = currentEditIndex) { /* ... same ... */ }
    async function sendEditEmail(emp, rec, action) { /* ... same ... */ }
    document.getElementById('editForm').addEventListener('submit', e=>{e.preventDefault();saveEdit();});

    /* --------------------------------------------------------------
       7. FILTERS & SEARCH
    -------------------------------------------------------------- */
    function filterHolidays() { /* ... same ... */ }
    function updateFilteredStats(records){ /* ... same ... */ }
    function filterEmployees(){ /* ... same ... */ }
    function formatDate(str){ const d=new Date(str); return d.toLocaleDateString('en-GB',{day:'2-digit',month:'short',year:'numeric'}); }

    /* --------------------------------------------------------------
       8. EXPORT
    -------------------------------------------------------------- */
    function exportAllToCSV(){ /* ... same ... */ }
    function exportEmployeeToCSV(){ /* ... same ... */ }
    function downloadCSV(csv, name){ const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'})); a.download=name; a.click(); }

    /* --------------------------------------------------------------
       9. INITIALISE – wait for EMPLOYEES
    -------------------------------------------------------------- */
    function startApp() {
        if (typeof EMPLOYEES === 'undefined' || !EMPLOYEES.data) {
            // Firebase still loading
            setTimeout(startApp, 100);
            return;
        }

        // Initial render
        renderEmployeeList();

        // Keep UI in sync with Firebase changes
        EMPLOYEES.onUpdate(() => {
            renderEmployeeList();
            if (selectedEmployeeId) {
                const e = EMPLOYEES.data.find(x => x.id === selectedEmployeeId);
                if (e) loadHolidayData(e);
            }
        });
    }

    // Kick-off
    startApp();
</script>
