<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Holiday Overview | NGU-hrs</title>

    <!-- EMAILJS SDK -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

    <style>
        * { margin:0; padding:0; box-sizing:border-box; }
        body { font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;
               background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
               min-height:100vh; padding:20px; }
        .container { max-width:1400px; margin:0 auto; }

        header { background:rgba(255,255,255,0.95); padding:25px 30px;
                 border-radius:15px; box-shadow:0 10px 30px rgba(0,0,0,0.2);
                 margin-bottom:30px; display:flex; justify-content:space-between;
                 align-items:center; }
        .header-left h1 { color:#667eea; font-size:2.2em; font-weight:700; }
        .header-left p { color:#666; margin-top:5px; }
        .back-btn { background:linear-gradient(135deg,#667eea,#764ba2);
                    color:white; padding:12px 25px; border:none; border-radius:8px;
                    cursor:pointer; font-size:1em; transition:transform .2s;
                    text-decoration:none; display:inline-block; }
        .back-btn:hover { transform:translateY(-2px);
                          box-shadow:0 5px 15px rgba(0,0,0,0.2); }

        .controls { background:rgba(255,255,255,0.95); padding:20px; border-radius:15px;
                    box-shadow:0 8px 25px rgba(0,0,0,0.15); margin-bottom:25px;
                    display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:15px; }
        .toggle-group { display:flex; gap:20px; flex-wrap:wrap; }
        .toggle-switch { display:flex; align-items:center; gap:10px; font-size:0.95em; color:#333; }
        .switch { position:relative; display:inline-block; width:50px; height:26px; }
        .switch input { opacity:0; width:0; height:0; }
        .slider { position:absolute; cursor:pointer; top:0; left:0; right:0; bottom:0;
                  background:#ccc; transition:.4s; border-radius:34px; }
        .slider:before { position:absolute; content:""; height:18px; width:18px; left:4px; bottom:4px;
                         background:white; transition:.4s; border-radius:50%; }
        input:checked + .slider { background:#28a745; }
        input:checked + .slider:before { transform:translateX(24px); }

        .search-section { background:rgba(255,255,255,0.95); padding:25px; border-radius:15px;
                          box-shadow:0 8px 25px rgba(0,0,0,0.15); margin-bottom:25px; }
        .search-box { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
        .search-box input { flex:1; min-width:250px; padding:12px 20px;
                            border:2px solid #e0e0e0; border-radius:8px; font-size:1em; transition:border .3s; }
        .search-box input:focus { outline:none; border-color:#667eea; }
        .search-btn { background:#667eea; color:white; border:none; padding:12px 20px;
                      border-radius:8px; cursor:pointer; font-size:1em; display:flex;
                      align-items:center; gap:8px; transition:all .3s; }
        .search-btn:hover { background:#5a6fd8; transform:translateY(-1px); }

        .content-area { display:grid; grid-template-columns:350px 1fr; gap:25px; }
        .employee-list { background:rgba(255,255,255,0.95); padding:25px;
                         border-radius:15px; box-shadow:0 8px 25px rgba(0,0,0,0.15);
                         max-height:700px; overflow-y:auto; }
        .employee-list h2 { color:#333; margin-bottom:20px; font-size:1.3em; }
        .employee-item { background:#f8f9fa; padding:15px 20px; border-radius:8px;
                         margin-bottom:10px; cursor:pointer; transition:all .3s;
                         border-left:4px solid #667eea; }
        .employee-item.leaver { border-left-color:#dc3545; opacity:0.8; }
        .employee-item:hover { background:#e9ecef; transform:translateX(5px); }
        .employee-item.active { background:linear-gradient(135deg,rgba(102,126,234,.1),rgba(118,75,162,.1));
                                border-left-color:#764ba2; }
        .employee-item strong { display:block; color:#333; font-size:1.05em; margin-bottom:3px; }
        .employee-item span { color:#666; font-size:0.9em; }

        .holiday-area { background:rgba(255,255,255,0.95); padding:30px;
                        border-radius:15px; box-shadow:0 8px 25px rgba(0,0,0,0.15); }
        .no-selection { text-align:center; padding:80px 20px; color:#666; }
        .no-selection-icon { font-size:5em; margin-bottom:20px; }

        .employee-header { margin-bottom:30px; padding-bottom:20px;
                           border-bottom:2px solid #e0e0e0; }
        .employee-header h2 { color:#667eea; font-size:1.8em; margin-bottom:5px; }
        .employee-header p { color:#666; }

        .holiday-stats { display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
                         gap:20px; margin-bottom:30px; }
        .stat-card { background:#f8f9fa; padding:20px; border-radius:10px;
                     border-left:4px solid #667eea; }
        .stat-card.taken { border-left-color:#dc3545; }
        .stat-card.requested { border-left-color:#ffc107; }
        .stat-card.remaining { border-left-color:#28a745; }
        .stat-label { color:#666; font-size:0.9em; margin-bottom:8px; display:block; }
        .stat-value { color:#333; font-size:2em; font-weight:700; }

        .section-title { color:#333; font-size:1.4em; margin-bottom:20px;
                         display:flex; align-items:center; gap:10px; }

        .holiday-history { margin-top:30px; }
        .holiday-record { background:#fff; padding:18px 22px; border-radius:10px;
                          margin-bottom:15px; border-left:4px solid #667eea;
                          position:relative; display:flex; justify-content:space-between;
                          align-items:flex-start; gap:15px; }
        .holiday-record.approved { border-left-color:#28a745; }
        .holiday-record.pending { border-left-color:#ffc107; }
        .holiday-record.rejected { border-left-color:#dc3545; }

        .record-main { flex:1; }
        .record-header { display:flex; justify-content:space-between;
                         align-items:center; margin-bottom:8px; flex-wrap:wrap; gap:8px; }
        .record-type { font-weight:700; font-size:1.1em; color:#333; }
        .record-status { padding:5px 15px; border-radius:20px; font-size:0.85em;
                         font-weight:600; white-space:nowrap; }
        .status-approved { background:#d4edda; color:#155724; }
        .status-pending { background:#fff3cd; color:#856404; }
        .status-rejected { background:#f8d7da; color:#721c24; }
        .record-dates { color:#666; font-size:0.95em; }
        .record-details { display:grid; grid-template-columns:repeat(auto-fit,minmax(120px,1fr));
                          gap:10px; margin-top:8px; }
        .record-detail-item { color:#666; font-size:0.9em; }
        .record-detail-item strong { color:#333; }
        .record-notes { margin-top:8px; padding-top:8px;
                        border-top:1px solid #e0e0e0; color:#666;
                        font-size:0.9em; font-style:italic; }

        .record-actions { display:flex; gap:6px; align-items:center; }
        .record-actions button { background:none; border:none; font-size:1.1em; cursor:pointer;
                                 padding:6px; border-radius:6px; transition:all .2s;
                                 width:34px; height:34px; display:flex; align-items:center;
                                 justify-content:center; }
        .record-actions button:hover { background:#f0f0f0; }
        .record-actions .edit-btn { color:#667eea; }
        .record-actions .delete-btn { color:#dc3545; }

        .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%;
                 background:rgba(0,0,0,0.5); z-index:1000;
                 justify-content:center; align-items:center; }
        .modal.active { display:flex; }
        .modal-content { background:white; padding:30px; border-radius:15px;
                         max-width:500px; width:90%; box-shadow:0 10px 40px rgba(0,0,0,0.3); }
        .modal-header { display:flex; justify-content:space-between;
                        align-items:center; margin-bottom:25px;
                        padding-bottom:15px; border-bottom:2px solid #e0e0e0; }
        .modal-header h2 { color:#667eea; font-size:1.5em; margin:0; }
        .close-modal { background:none; border:none; font-size:1.5em;
                       cursor:pointer; color:#666; padding:0; width:30px; height:30px;
                       display:flex; align-items:center; justify-content:center; }
        .close-modal:hover { color:#dc3545; }

        @media (max-width:968px) {
            .content-area { grid-template-columns:1fr; }
            header { flex-direction:column; gap:15px; text-align:center; }
            .holiday-stats { grid-template-columns:1fr; }
            .controls { flex-direction:column; align-items:stretch; }
            .search-box { flex-direction:column; }
            .search-btn { width:100%; justify-content:center; }
            .record-header { flex-direction:column; align-items:flex-start; }
            .record-actions { margin-top:10px; }
        }
    </style>
</head>
<body>

    <!-- 1. FIREBASE MODULE -->
    <script type="module" src="employees-firebase.js"></script>

    <div class="container">
        <header>
            <div class="header-left">
                <h1>Holiday Overview</h1>
                <p>View employee holiday statistics and history</p>
            </div>
            <a href="index.html" class="back-btn">Back to Dashboard</a>
        </header>

        <!-- TOGGLES -->
        <div class="controls">
            <div class="toggle-group">
                <div class="toggle-switch">
                    <label class="switch">
                        <input type="checkbox" id="showActive" checked>
                        <span class="slider"></span>
                    </label>
                    <span>Show Active</span>
                </div>
                <div class="toggle-switch">
                    <label class="switch">
                        <input type="checkbox" id="showLeavers">
                        <span class="slider"></span>
                    </label>
                    <span>Show Leavers</span>
                </div>
            </div>
            <div style="color:#666; font-size:0.9em;">
                Active: <strong id="activeCount">0</strong> | 
                Leavers: <strong id="leaverCount">0</strong>
            </div>
        </div>

        <div class="search-section">
            <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:15px;">
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="Search by employee name or ID..." onkeyup="if(event.key==='Enter') filterEmployees()">
                    <button class="search-btn" onclick="filterEmployees()">Search</button>
                </div>
                <button class="back-btn" onclick="exportAllToCSV()" style="background:#28a745; margin:0; padding:12px 20px;">Export All</button>
            </div>
        </div>

        <div class="content-area">
            <div class="employee-list">
                <h2>Employees</h2>
                <div id="employeeListContainer">
                    <p style="color:#666; text-align:center;">Loading employees...</p>
                </div>
            </div>

            <div class="holiday-area">
                <div id="noSelection" class="no-selection">
                    <div class="no-selection-icon">Holiday</div>
                    <h3>No Employee Selected</h3>
                    <p>Please select an employee from the list to view their holiday records</p>
                </div>

                <div id="employeeHoliday" style="display:none;">
                    <div class="employee-header">
                        <h2 id="employeeName">Employee Name</h2>
                        <p id="employeeId">Employee ID</p>
                    </div>

                    <div class="holiday-stats">
                        <div class="stat-card">
                            <span class="stat-label">Total Entitlement</span>
                            <span class="stat-value" id="totalEntitlement">0</span>
                        </div>
                        <div class="stat-card taken">
                            <span class="stat-label">Days Taken</span>
                            <span class="stat-value" id="daysTaken">0</span>
                        </div>
                        <div class="stat-card requested">
                            <span class="stat-label">Days Requested</span>
                            <span class="stat-value" id="daysRequested">0</span>
                        </div>
                        <div class="stat-card remaining">
                            <span class="stat-label">Days Remaining</span>
                            <span class="stat-value" id="daysRemaining">0</span>
                        </div>
                    </div>

                    <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:15px; margin-bottom:20px;">
                        <h3 class="section-title" style="margin:0;">Holiday History</h3>
                        <div style="display:flex; gap:15px; flex-wrap:wrap;">
                            <div>
                                <label for="filterStatus" style="margin-bottom:5px; font-size:0.9em;">Filter by Status:</label>
                                <select id="filterStatus" onchange="filterHolidays()" style="padding:8px 12px; width:180px;">
                                    <option value="all">All Status</option>
                                    <option value="approved">Approved</option>
                                    <option value="pending">Pending</option>
                                    <option value="rejected">Rejected</option>
                                </select>
                            </div>
                            <div>
                                <label for="filterMonth" style="margin-bottom:5px; font-size:0.9em;">Filter by Month:</label>
                                <input type="month" id="filterMonth" onchange="filterHolidays()" style="padding:8px 12px; width:180px;">
                            </div>
                            <div>
                                <button onclick="exportEmployeeToCSV()" style="padding:8px 20px; background:#667eea; color:white; border:none; border-radius:8px; cursor:pointer; font-size:0.95em;">Export This Employee</button>
                            </div>
                        </div>
                    </div>
                    <div class="holiday-history" id="holidayHistory"></div>
                </div>
            </div>
        </div>

        <!-- Edit Modal -->
        <div id="editModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Edit Holiday Record</h2>
                    <button class="close-modal" onclick="closeEditModal()">X</button>
                </div>
                <form id="editForm">
                    <input type="hidden" id="editIndex">
                    <div class="form-group">
                        <label for="editStatus">Status *</label>
                        <select id="editStatus" required>
                            <option value="approved">Approved</option>
                            <option value="pending">Pending</option>
                            <option value="rejected">Rejected</option>
                        </select>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editDateFrom">Date From *</label>
                            <input type="date" id="editDateFrom" required>
                        </div>
                        <div class="form-group">
                            <label for="editDateTo">Date To *</label>
                            <input type="date" id="editDateTo" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="editDays">Days *</label>
                        <input type="number" id="editDays" step="0.5" min="0.5" required>
                    </div>
                    <div class="form-group">
                        <label for="editType">Type</label>
                        <select id="editType">
                            <option value="Full Day">Full Day</option>
                            <option value="Morning Only">Morning Only</option>
                            <option value="Afternoon Only">Afternoon Only</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editNotes">Notes</label>
                        <textarea id="editNotes"></textarea>
                    </div>
                    <div class="btn-group">
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                        <button type="button" class="btn btn-danger" onclick="deleteRecord()">Delete Record</button>
                        <button type="button" class="btn btn-secondary" onclick="closeEditModal()">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 2. MAIN SCRIPT -->
    <script>
        /* --------------------------------------------------------------
           1. GLOBAL STATE
        -------------------------------------------------------------- */
        let selectedEmployeeId = null;
        let allRecords = [];
        let currentEditIndex = -1;

        const EMAILJS_SERVICE_ID = 'service_9dr2ws7';
        const EMAILJS_TEMPLATE_ID = 'template_cpujhfa';
        const EMAILJS_PUBLIC_KEY = 'ziLnha91scpGjFABh';
        const MANAGERS = [
            'barry.dixon@next-gen.uk','Marie.Wall@next-gen.uk','Carl.Finnigan@next-gen.uk',
            'ashleigh.ginks@next-gen.uk','Maia.foster@next-gen.uk','Rebecca.Salter@next-gen.uk'
        ];
        emailjs.init(EMAILJS_PUBLIC_KEY);

        /* --------------------------------------------------------------
           2. HELPERS – past-holiday auto-approve
        -------------------------------------------------------------- */
        const TODAY = new Date(); TODAY.setHours(0,0,0,0);
        const isHolidayInPast = r => {
            const end = new Date(r.dateTo); end.setHours(0,0,0,0);
            return end < TODAY;
        };
        const effectiveStatus = r => isHolidayInPast(r) ? 'approved' : r.status;

        /* --------------------------------------------------------------
           3. RENDER EMPLOYEE LIST
        -------------------------------------------------------------- */
        function renderEmployeeList() {
            const container = document.getElementById('employeeListContainer');
            const showActive = document.getElementById('showActive').checked;
            const showLeavers = document.getElementById('showLeavers').checked;

            const active = EMPLOYEES.data.filter(e => !e.dateLeft);
            const leavers = EMPLOYEES.data.filter(e => e.dateLeft);
            document.getElementById('activeCount').textContent = active.length;
            document.getElementById('leaverCount').textContent = leavers.length;

            let toShow = [];
            if (showActive && showLeavers) toShow = EMPLOYEES.data;
            else if (showActive) toShow = active;
            else if (showLeavers) toShow = leavers;

            if (!toShow.length) {
                container.innerHTML = '<p style="color:#666; text-align:center;">No employees to show</p>';
                return;
            }

            container.innerHTML = '';
            toShow.forEach(emp => {
                const div = document.createElement('div');
                div.className = `employee-item ${emp.dateLeft ? 'leaver' : ''}`;
                div.onclick = () => selectEmployee(emp.id);
                div.innerHTML = `<strong>${emp.name}</strong><span>ID: ${emp.id}</span>`;
                container.appendChild(div);
            });
        }

        /* --------------------------------------------------------------
           4. SELECT EMPLOYEE
        -------------------------------------------------------------- */
        function selectEmployee(id) {
            selectedEmployeeId = id;
            const emp = EMPLOYEES.data.find(e => e.id === id);
            if (!emp) return;

            document.querySelectorAll('.employee-item').forEach(i => i.classList.remove('active'));
            const el = document.querySelector(`.employee-item[onclick="selectEmployee('${id}')"]`);
            if (el) el.classList.add('active');

            document.getElementById('noSelection').style.display = 'none';
            document.getElementById('employeeHoliday').style.display = 'block';
            document.getElementById('employeeName').textContent = emp.name;
            document.getElementById('employeeId').textContent = 'ID: ' + emp.id;

            loadHolidayData(emp);
        }

        /* --------------------------------------------------------------
           5. LOAD & DISPLAY HOLIDAY DATA
        -------------------------------------------------------------- */
        function loadHolidayData(emp) {
            const records = emp.holidays || [];
            allRecords = [...records];

            const total = emp.holidayEntitlement || 28;
            const taken = records.filter(r => effectiveStatus(r) === 'approved')
                                 .reduce((s,r)=>s+parseFloat(r.days),0);
            const requested = records.filter(r => effectiveStatus(r) === 'pending')
                                     .reduce((s,r)=>s+parseFloat(r.days),0);
            const remaining = total - taken - requested;

            document.getElementById('totalEntitlement').textContent = total;
            document.getElementById('daysTaken').textContent = taken;
            document.getElementById('daysRequested').textContent = requested;
            document.getElementById('daysRemaining').textContent = remaining;

            document.getElementById('filterStatus').value = 'all';
            document.getElementById('filterMonth').value = '';

            displayHolidayRecords(records);
        }

        function displayHolidayRecords(records) {
            const container = document.getElementById('holidayHistory');
            if (!records.length) {
                container.innerHTML = '<p style="color:#666;text-align:center;padding:40px;">No holiday records found</p>';
                return;
            }

            const labels = {approved:'Approved',pending:'Pending',rejected:'Rejected'};
            const classes = {approved:'status-approved',pending:'status-pending',rejected:'status-rejected'};

            let html = '';
            records.forEach((r, i) => {
                const eff = effectiveStatus(r);
                const auto = (r.status==='pending' && eff==='approved') ? ' <small style="opacity:.7">(Auto-Approved)</small>' : '';
                html += `
                    <div class="holiday-record ${eff}">
                        <div class="record-main">
                            <div class="record-header">
                                <span class="record-type">${r.type||'Full Day'}</span>
                                <span class="record-status ${classes[eff]}">${labels[eff]}${auto}</span>
                            </div>
                            <div class="record-dates">${formatDate(r.dateFrom)} - ${formatDate(r.dateTo)}</div>
                            <div class="record-details">
                                <div class="record-detail-item"><strong>Days:</strong> ${r.days}</div>
                            </div>
                            ${r.notes?`<div class="record-notes">${r.notes}</div>`:''}
                        </div>
                        <div class="record-actions">
                            <button class="edit-btn" onclick="openEditModal(${i})" title="Edit">Edit</button>
                            <button class="delete-btn" onclick="deleteRecord(${i})" title="Delete">Delete</button>
                        </div>
                    </div>`;
            });
            container.innerHTML = html;
        }

        /* --------------------------------------------------------------
           6. EDIT MODAL
        -------------------------------------------------------------- */
        function openEditModal(idx) {
            currentEditIndex = idx;
            const r = allRecords[idx];
            document.getElementById('editStatus').value = r.status;
            document.getElementById('editDateFrom').value = r.dateFrom;
            document.getElementById('editDateTo').value = r.dateTo;
            document.getElementById('editDays').value = r.days;
            document.getElementById('editType').value = r.type || 'Full Day';
            document.getElementById('editNotes').value = r.notes || '';
            document.getElementById('editModal').classList.add('active');
        }
        function closeEditModal() {
            document.getElementById('editModal').classList.remove('active');
            currentEditIndex = -1;
        }

        async function saveEdit() {
            if (currentEditIndex===-1) return;
            const emp = EMPLOYEES.data.find(e=>e.id===selectedEmployeeId);
            const rec = {
                status: document.getElementById('editStatus').value,
                dateFrom: document.getElementById('editDateFrom').value,
                dateTo: document.getElementById('editDateTo').value,
                days: parseFloat(document.getElementById('editDays').value),
                type: document.getElementById('editType').value,
                notes: document.getElementById('editNotes').value,
                submittedAt: allRecords[currentEditIndex].submittedAt
            };
            emp.holidays[currentEditIndex] = rec;
            try {
                await EMPLOYEES.update(emp.id, {holidays: emp.holidays});
                alert('Holiday record updated!');
                await sendEditEmail(emp, rec, 'edited');
                closeEditModal();
                loadHolidayData(emp);
            } catch(e){ alert('Update failed.'); }
        }

        async function deleteRecord(idx = currentEditIndex) {
            if (!confirm('Delete this holiday record?')) return;
            const emp = EMPLOYEES.data.find(e=>e.id===selectedEmployeeId);
            const rec = emp.holidays[idx];
            emp.holidays.splice(idx,1);
            try {
                await EMPLOYEES.update(emp.id, {holidays: emp.holidays});
                alert('Record deleted!');
                await sendEditEmail(emp, rec, 'deleted');
                closeEditModal();
                loadHolidayData(emp);
            } catch(e){ alert('Delete failed.'); }
        }

        async function sendEditEmail(emp, rec, action) {
            const eff = effectiveStatus(rec);
            const label = eff==='approved'?'Approved':eff==='pending'?'Pending':'Rejected';
            const auto = (rec.status==='pending' && eff==='approved')?' (Auto-Approved)':'';

            const params = {
                employee_name: emp.name, employee_id: emp.id,
                type: rec.type||'Full Day', date_from: rec.dateFrom, date_to: rec.dateTo,
                days: rec.days, status: label+auto, notes: rec.notes||'—',
                action, remaining_days: (emp.holidayEntitlement||28) -
                    emp.holidays.filter(r=>effectiveStatus(r)==='approved')
                               .reduce((s,r)=>s+parseFloat(r.days),0) -
                    emp.holidays.filter(r=>effectiveStatus(r)==='pending')
                               .reduce((s,r)=>s+parseFloat(r.days),0)
            };
            await Promise.all(MANAGERS.map(m=>emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID,
                {...params, to_email:m}))).catch(()=>{});
        }

        document.getElementById('editForm').addEventListener('submit', e=>{e.preventDefault();saveEdit();});

        /* --------------------------------------------------------------
           7. FILTERS & SEARCH
        -------------------------------------------------------------- */
        function filterHolidays() {
            const status = document.getElementById('filterStatus').value;
            const month = document.getElementById('filterMonth').value;
            let filtered = [...allRecords];

            if (status!=='all'){
                if (status==='pending'){
                    filtered = filtered.filter(r=>!isHolidayInPast(r) && r.status==='pending');
                } else {
                    filtered = filtered.filter(r=>effectiveStatus(r)===status);
                }
            }
            if (month) filtered = filtered.filter(r=>r.dateFrom.substring(0,7)===month);

            updateFilteredStats(filtered);
            displayHolidayRecords(filtered);
        }

        function updateFilteredStats(records){
            const emp = EMPLOYEES.data.find(e=>e.id===selectedEmployeeId);
            const total = emp.holidayEntitlement||28;
            const taken = records.filter(r=>effectiveStatus(r)==='approved')
                                 .reduce((s,r)=>s+parseFloat(r.days),0);
            const requested = records.filter(r=>effective effectiveStatus(r)==='pending')
                                     .reduce((s,r)=>s+parseFloat(r.days),0);
            const remaining = total-taken-requested;
            document.getElementById('daysTaken').textContent = taken;
            document.getElementById('daysRequested').textContent = requested;
            document.getElementById('daysRemaining').textContent = remaining;
        }

        function filterEmployees(){
            const term = document.getElementById('searchInput').value.trim().toLowerCase();
            document.querySelectorAll('.employee-item').forEach(it=>{
                it.style.display = it.textContent.toLowerCase().includes(term) ? 'block' : 'none';
            });
        }

        function formatDate(str){
            const d = new Date(str);
            return d.toLocaleDateString('en-GB',{day:'2-digit',month:'short',year:'numeric'});
        }

        /* --------------------------------------------------------------
           8. EXPORT
        -------------------------------------------------------------- */
        function exportAllToCSV(){
            let csv = 'Employee ID,Name,Total Entitlement,Days Taken,Days Requested,Days Remaining,Status,Date From,Date To,Days,Type,Notes\n';
            EMPLOYEES.data.forEach(emp=>{
                const total = emp.holidayEntitlement||28;
                const taken = (emp.holidays||[]).filter(r=>effectiveStatus(r)==='approved')
                                                .reduce((s,r)=>s+parseFloat(r.days),0);
                const requested = (emp.holidays||[]).filter(r=>effectiveStatus(r)==='pending')
                                                    .reduce((s,r)=>s+parseFloat(r.days),0);
                const remaining = total-taken-requested;
                if (!emp.holidays||!emp.holidays.length){
                    csv += `"${emp.id}","${emp.name}",${total},${taken},${requested},${remaining},,,,,,\n`;
                } else {
                    emp.holidays.forEach(r=>{
                        const eff = effectiveStatus(r);
                        const lbl = (eff==='approved' && r.status==='pending')?'approved (auto)':eff;
                        csv += `"${emp.id}","${emp.name}",${total},${taken},${requested},${remaining},"${lbl}","${r.dateFrom}","${r.dateTo}",${r.days},"${r.type||'Full Day'}","${(r.notes||'').replace(/"/g,'""')}"\n`;
                    });
                }
            });
            downloadCSV(csv,`All_Holidays_${new Date().toISOString().split('T')[0]}.csv`);
        }

        function exportEmployeeToCSV(){
            if (!selectedEmployeeId) return alert('Select an employee');
            const emp = EMPLOYEES.data.find(e=>e.id===selectedEmployeeId);
            let recs = [...allRecords];
            const status = document.getElementById('filterStatus').value;
            const month = document.getElementById('filterMonth').value;
            if (status!=='all'){
                if (status==='pending') recs = recs.filter(r=>!isHolidayInPast(r) && r.status==='pending');
                else recs = recs.filter(r=>effectiveStatus(r)===status);
            }
            if (month) recs = recs.filter(r=>r.dateFrom.substring(0,7)===month);
            if (!recs.length) return alert('No records to export');

            const total = emp.holidayEntitlement||28;
            const taken = recs.filter(r=>effectiveStatus(r)==='approved')
                              .reduce((s,r)=>s+parseFloat(r.days),0);
            const requested = recs.filter(r=>effectiveStatus(r)==='pending')
                                  .reduce((s,r)=>s+parseFloat(r.days),0);
            const remaining = total-taken-requested;

            let csv = 'Employee ID,Name,Total Entitlement,Days Taken,Days Requested,Days Remaining,Status,Date From,Date To,Days,Type,Notes\n';
            recs.forEach(r=>{
                const eff = effectiveStatus(r);
                const lbl = (eff==='approved' && r.status==='pending')?'approved (auto)':eff;
                csv += `"${emp.id}","${emp.name}",${total},${taken},${requested},${remaining},"${lbl}","${r.dateFrom}","${r.dateTo}",${r.days},"${r.type||'Full Day'}","${(r.notes||'').replace(/"/g,'""')}"\n`;
            });
            const suffix = (status!=='all'?`_${status}`:'') + (month?`_${month}`:'');
            downloadCSV(csv,`Holiday_${emp.id}${suffix}_${new Date().toISOString().split('T')[0]}.csv`);
        }

        function downloadCSV(csv, name){
            const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = name;
            a.click();
        }

        /* --------------------------------------------------------------
           9. INITIALISE – wait for EMPLOYEES to exist
        -------------------------------------------------------------- */
        function startApp() {
            if (typeof EMPLOYEES === 'undefined' || !EMPLOYEES.data) {
                // Firebase still loading – try again
                setTimeout(startApp, 100);
                return;
            }

            // First render
            renderEmployeeList();

            // Keep UI in sync
            EMPLOYEES.onUpdate(() => {
                renderEmployeeList();
                if (selectedEmployeeId) {
                    const e = EMPLOYEES.data.find(x=>x.id===selectedEmployeeId);
                    if (e) loadHolidayData(e);
                }
            });
        }

        // Kick-off
        startApp();
    </script>
</body>
</html>
