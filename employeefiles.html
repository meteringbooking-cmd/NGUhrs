<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Employee Files | NGU-hrs</title>
    <style>
        * { margin:0; padding:0; box-sizing:border-box; }
        body { font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;
               background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
               min-height:100vh; padding:20px; }
        .container { max-width:1200px; margin:0 auto; }

        header { background:rgba(255,255,255,0.95); padding:25px 30px;
                 border-radius:15px; box-shadow:0 10px 30px rgba(0,0,0,0.2);
                 margin-bottom:30px; display:flex; justify-content:space-between;
                 align-items:center; }
        .header-left h1 { color:#667eea; font-size:2.2em; font-weight:700; }
        .header-left p { color:#666; margin-top:5px; }
        .back-btn { background:linear-gradient(135deg,#667eea,#764ba2);
                    color:white; padding:12px 25px; border:none; border-radius:8px;
                    cursor:pointer; font-size:1em; transition:transform .2s;
                    text-decoration:none; display:inline-block; }
        .back-btn:hover { transform:translateY(-2px);
                          box-shadow:0 5px 15px rgba(0,0,0,0.2); }

        .controls {
            background:rgba(255,255,255,0.95); padding:20px; border-radius:15px;
            box-shadow:0 8px 25px rgba(0,0,0,0.15); margin-bottom:25px;
            display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:15px;
        }
        .toggle-group {
            display:flex; gap:20px; flex-wrap:wrap;
        }
        .toggle-switch {
            display:flex; align-items:center; gap:10px; font-size:0.95em; color:#333;
        }
        .switch {
            position:relative; display:inline-block; width:50px; height:26px;
        }
        .switch input { opacity:0; width:0; height:0; }
        .slider {
            position:absolute; cursor:pointer; top:0; left:0; right:0; bottom:0;
            background:#ccc; transition:.4s; border-radius:34px;
        }
        .slider:before {
            position:absolute; content:""; height:18px; width:18px; left:4px; bottom:4px;
            background:white; transition:.4s; border-radius:50%;
        }
        input:checked + .slider { background:#28a745; }
        input:checked + .slider:before { transform:translateX(24px); }

        .search-section { background:rgba(255,255,255,0.95); padding:25px;
                          border-radius:15px; box-shadow:0 8px 25px rgba(0,0,0,0.15);
                          margin-bottom:25px; }
        .search-box { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
        .search-box input { flex:1; min-width:250px; padding:12px 20px;
                            border:2px solid #e0e0e0; border-radius:8px;
                            font-size:1em; transition:border .3s; }
        .search-box input:focus { outline:none; border-color:#667eea; }
        .search-btn {
            background:#667eea; color:white; border:none; padding:12px 20px;
            border-radius:8px; cursor:pointer; font-size:1em; display:flex;
            align-items:center; gap:8px; transition:all .3s;
        }
        .search-btn:hover { background:#5a6fd8; transform:translateY(-1px); }

        .employee-list {
            background:rgba(255,255,255,0.95); padding:25px;
            border-radius:15px; box-shadow:0 8px 25px rgba(0,0,0,0.15);
            max-height:700px; overflow-y:auto;
        }
        .employee-list h2 { color:#333; margin-bottom:20px; font-size:1.3em; }
        .employee-item {
            background:#f8f9fa; padding:15px 20px; border-radius:8px;
            margin-bottom:10px; cursor:pointer; transition:all .3s;
            border-left:4px solid #667eea;
        }
        .employee-item.leaver { border-left-color:#dc3545; opacity:0.8; }
        .employee-item:hover { background:#e9ecef; transform:translateX(5px); }
        .employee-item.active {
            background:linear-gradient(135deg,rgba(102,126,234,.1),rgba(118,75,162,.1));
            border-left-color:#764ba2;
        }
        .employee-item strong { display:block; color:#333; font-size:1.05em; margin-bottom:3px; }
        .employee-item span { color:#666; font-size:0.9em; }

        .employee-details {
            background:rgba(255,255,255,0.95); padding:30px;
            border-radius:15px; box-shadow:0 8px 25px rgba(0,0,0,0.15);
        }
        .detail-section { margin-bottom:30px; }
        .detail-section h3 {
            color:#667eea; font-size:1.3em; margin-bottom:15px;
            padding-bottom:10px; border-bottom:2px solid #e0e0e0;
        }
        .detail-grid {
            display:grid; grid-template-columns:repeat(auto-fit,minmax(250px,1fr));
            gap:20px; margin-top:15px;
        }
        .detail-item {
            background:#f8f9fa; padding:15px; border-radius:8px;
        }
        .detail-label {
            color:#666; font-size:0.85em; font-weight:600;
            text-transform:uppercase; margin-bottom:5px; display:block;
        }
        .detail-value {
            color:#333; font-size:1.1em; font-weight:500;
        }

        .no-employee {
            text-align:center; padding:60px 20px; color:#666;
        }
        .no-employee-icon { font-size:4em; margin-bottom:20px; }

        .action-buttons {
            display:flex; gap:15px; margin-top:30px; flex-wrap:wrap;
        }
        .btn {
            padding:12px 25px; border:none; border-radius:8px;
            cursor:pointer; font-size:1em; transition:all .3s;
        }
        .btn-primary {
            background:linear-gradient(135deg,#667eea,#764ba2); color:white;
        }
        .btn-secondary {
            background:#6c757d; color:white;
        }
        .btn-danger {
            background:#dc3545; color:white;
        }
        .btn:hover {
            transform:translateY(-2px);
            box-shadow:0 5px 15px rgba(0,0,0,0.2);
        }

        .modal {
            display:none; position:fixed; top:0; left:0; width:100%; height:100%;
            background:rgba(0,0,0,0.5); z-index:1000;
            justify-content:center; align-items:center;
        }
        .modal.active { display:flex; }
        .modal-content {
            background:white; padding:30px; border-radius:15px;
            max-width:700px; width:90%; max-height:90vh; overflow-y:auto;
            box-shadow:0 10px 40px rgba(0,0,0,0.3);
        }
        .modal-header {
            display:flex; justify-content:space-between;
            align-items:center; margin-bottom:25px;
            padding-bottom:15px; border-bottom:2px solid #e0e0e0;
        }
        .modal-header h2 {
            color:#667eea; font-size:1.5em; margin:0;
        }
        .close-modal {
            background:none; border:none; font-size:1.5em;
            cursor:pointer; color:#666; padding:0; width:30px; height:30px;
            display:flex; align-items:center; justify-content:center;
        }
        .close-modal:hover { color:#dc3545; }
        .form-grid {
            display:grid; grid-template-columns:1fr 1fr; gap:20px;
        }
        .form-group { margin-bottom:20px; }
        label {
            display:block; color:#333; font-weight:600; margin-bottom:8px;
            font-size:0.95em;
        }
        input, textarea, select {
            width:100%; padding:12px; border:2px solid #e0e0e0;
            border-radius:8px; font-size:1em; transition:border .3s;
        }
        input:focus, textarea:focus, select:focus {
            outline:none; border-color:#667eea;
        }
        textarea { resize:vertical; min-height:80px; }

        @media (max-width:768px) {
            header { flex-direction:column; gap:15px; text-align:center; }
            .detail-grid, .form-grid { grid-template-columns:1fr; }
            .action-buttons { flex-direction:column; }
            .controls { flex-direction:column; align-items:stretch; }
            .search-box { flex-direction:column; }
            .search-btn { width:100%; justify-content:center; }
        }
    </style>
</head>
<body>

    <!-- 1. FIREBASE FIRST -->
    <script type="module" src="employees-firebase.js"></script>

    <div class="container">
        <header>
            <div class="header-left">
                <h1>Employee Files</h1>
                <p>View and manage employee information</p>
            </div>
            <a href="index.html" class="back-btn">Back to Dashboard</a>
        </header>

        <!-- TOGGLES -->
        <div class="controls">
            <div class="toggle-group">
                <div class="toggle-switch">
                    <label class="switch">
                        <input type="checkbox" id="showActive" onchange="renderEmployeeList()">
                        <span class="slider"></span>
                    </label>
                    <span>Show Active</span>
                </div>
                <div class="toggle-switch">
                    <label class="switch">
                        <input type="checkbox" id="showLeavers" onchange="renderEmployeeList()">
                        <span class="slider"></span>
                    </label>
                    <span>Show Leavers</span>
                </div>
            </div>
            <div style="color:#666; font-size:0.9em;">
                Active: <strong id="activeCount">0</strong> | 
                Leavers: <strong id="leaverCount">0</strong>
            </div>
        </div>

        <div class="search-section">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="Search by name or employee ID..." onkeyup="if(event.key==='Enter') filterEmployees()">
                <button class="search-btn" onclick="filterEmployees()">Search</button>
            </div>
        </div>

        <div class="employee-list">
            <h2>Employee List</h2>
            <div id="employeeListContainer">
                <p style="color:#666; text-align:center;">Loading employees...</p>
            </div>
        </div>

        <div class="employee-details" id="employeeDetails">
            <div class="no-employee">
                <div class="no-employee-icon">Person</div>
                <h3>No Employee Selected</h3>
                <p>Please select an employee from the list above to view their details</p>
            </div>
        </div>
    </div>

    <!-- EDIT MODAL -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Employee</h2>
                <button class="close-modal" onclick="closeEditModal()">X</button>
            </div>
            <form id="editForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Full Name *</label>
                        <input type="text" id="editName" required>
                    </div>
                    <div class="form-group">
                        <label>Employee ID</label>
                        <input type="text" id="editId" disabled>
                    </div>
                    <div class="form-group" style="grid-column:1/-1;">
                        <label>Address</label>
                        <textarea id="editAddress"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Personal Phone</label>
                        <input type="text" id="editPersonalPhone">
                    </div>
                    <div class="form-group">
                        <label>Personal Email</label>
                        <input type="email" id="editPersonalEmail">
                    </div>
                    <div class="form-group">
                        <label>Work Phone</label>
                        <input type="text" id="editWorkPhone">
                    </div>
                    <div class="form-group">
                        <label>Work Email</label>
                        <input type="email" id="editWorkEmail">
                    </div>
                    <div class="form-group">
                        <label>Job Title</label>
                        <input type="text" id="editJobTitle">
                    </div>
                    <div class="form-group">
                        <label>Start Date</label>
                        <input type="date" id="editStartDate">
                    </div>
                    <div class="form-group">
                        <label>Payment Type</label>
                        <select id="editPaymentType">
                            <option value="Monthly Salary">Monthly Salary</option>
                            <option value="Hourly">Hourly</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Full Time Pay</label>
                        <input type="text" id="editFullTimePay">
                    </div>
                </div>
                <div style="display:flex; gap:15px; margin-top:20px;">
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                    <button type="button" class="btn btn-danger" onclick="deleteEmployee()">Delete Employee</button>
                    <button type="button" class="btn btn-secondary" onclick="closeEditModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let selectedEmp = null;

        // ────────────────────── 1. Render Employee List with Toggles ──────────────────────
        function renderEmployeeList() {
            const container = document.getElementById('employeeListContainer');
            const showActive = document.getElementById('showActive').checked;
            const showLeavers = document.getElementById('showLeavers').checked;

            const active = EMPLOYEES.data.filter(e => !e.dateLeft);
            const leavers = EMPLOYEES.data.filter(e => e.dateLeft);

            document.getElementById('activeCount').textContent = active.length;
            document.getElementById('leaverCount').textContent = leavers.length;

            let employeesToShow = [];
            if (showActive && showLeavers) employeesToShow = EMPLOYEES.data;
            else if (showActive) employeesToShow = active;
            else if (showLeavers) employeesToShow = leavers;

            if (!employeesToShow.length) {
                container.innerHTML = '<p style="color:#666; text-align:center;">No employees to show</p>';
                return;
            }
            employeesToShow.sort((a, b) => {
    const nameA = (a.name || '').toLowerCase();
    const nameB = (b.name || '').toLowerCase();
    return nameA.localeCompare(nameB);
});

            container.innerHTML = '';
            employeesToShow.forEach(emp => {
                const isLeaver = !!emp.dateLeft;
                const item = document.createElement('div');
                item.className = `employee-item ${isLeaver ? 'leaver' : ''}`;
                item.onclick = () => selectEmployee(emp);
                item.innerHTML = `<strong>${emp.name}</strong><span>ID: ${emp.id}</span>`;
                container.appendChild(item);
            });
        }

        // ────────────────────── 2. Select Employee ──────────────────────
        function selectEmployee(emp) {
            selectedEmp = emp;
            document.querySelectorAll('.employee-item').forEach(i => i.classList.remove('active'));
            const activeItem = document.querySelector(`.employee-item[onclick="selectEmployee(EMPLOYEES.data.find(e=>e.id==='${emp.id}'))"]`);
            if (activeItem) activeItem.classList.add('active');

            const e = emp;
            const holidayEntitlement = e.holidayEntitlement || 28;
            const holidayTaken = (e.holidays || []).filter(r => r.status === 'approved').reduce((s, r) => s + parseFloat(r.days), 0);
            const holidayRemaining = holidayEntitlement - holidayTaken;

            document.getElementById('employeeDetails').innerHTML = `
                <div class="detail-section">
                    <h3>Employee Details</h3>
                    <div class="detail-grid">
                        <div class="detail-item"><span class="detail-label">Full Name</span><span class="detail-value">${e.name}</span></div>
                        <div class="detail-item"><span class="detail-label">Employee ID</span><span class="detail-value">${e.id}</span></div>
                        <div class="detail-item" style="grid-column:1/-1;"><span class="detail-label">Address</span><span class="detail-value">${e.address || '—'}</span></div>
                        <div class="detail-item"><span class="detail-label">Personal Phone</span><span class="detail-value">${e.personalPhone || '—'}</span></div>
                        <div class="detail-item"><span class="detail-label">Personal Email</span><span class="detail-value">${e.personalEmail || '—'}</span></div>
                    </div>
                </div>

                <div class="detail-section">
                    <h3>Work Contact</h3>
                    <div class="detail-grid">
                        <div class="detail-item"><span class="detail-label">Work Phone</span><span class="detail-value">${e.workPhone || '—'}</span></div>
                        <div class="detail-item"><span class="detail-label">Work Email</span><span class="detail-value">${e.workEmail || '—'}</span></div>
                    </div>
                </div>

                <div class="detail-section">
                    <h3>Holiday Info</h3>
                    <div class="detail-grid">
                        <div class="detail-item"><span class="detail-label">Entitlement</span><span class="detail-value">${holidayEntitlement} days</span></div>
                        <div class="detail-item"><span class="detail-label">Taken</span><span class="detail-value">${holidayTaken} days</span></div>
                        <div class="detail-item"><span class="detail-label">Remaining</span><span class="detail-value">${holidayRemaining} days</span></div>
                    </div>
                </div>

                <div class="detail-section">
                    <h3>Work Info</h3>
                    <div class="detail-grid">
                        <div class="detail-item"><span class="detail-label">Job Title</span><span class="detail-value">${e.jobTitle || '—'}</span></div>
                        <div class="detail-item"><span class="detail-label">Start Date</span><span class="detail-value">${e.startDate || '—'}</span></div>
                        <div class="detail-item"><span class="detail-label">Probation</span><span class="detail-value">${e.probationStatus || '—'}</span></div>
                    </div>
                </div>

                <div class="detail-section">
                    <h3>Pay Info</h3>
                    <div class="detail-grid">
                        <div class="detail-item"><span class="detail-label">Payment Type</span><span class="detail-value">${e.paymentType || '—'}</span></div>
                        <div class="detail-item"><span class="detail-label">Full Time Pay</span><span class="detail-value">${e.fullTimePay || '—'}</span></div>
                        <div class="detail-item"><span class="detail-label">Pay Start Date</span><span class="detail-value">${e.payDealStartDate || '—'}</span></div>
                    </div>
                </div>

                <div class="detail-section">
                    <h3>Sickness Info</h3>
                    <div class="detail-grid">
                        <div class="detail-item"><span class="detail-label">Days Taken</span><span class="detail-value">${e.absenceDays || 0}</span></div>
                        <div class="detail-item"><span class="detail-label">Incidents</span><span class="detail-value">${(e.absences || []).filter(a => a.type === 'sickness').length}</span></div>
                    </div>
                </div>

                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="openEditModal()">Edit Details</button>
                    <button class="btn btn-secondary" onclick="window.print()">Print</button>
                </div>
            `;
        }

        // ────────────────────── 3. Edit Modal ──────────────────────
        function openEditModal() {
            if (!selectedEmp) return;
            document.getElementById('editName').value = selectedEmp.name;
            document.getElementById('editId').value = selectedEmp.id;
            document.getElementById('editAddress').value = selectedEmp.address || '';
            document.getElementById('editPersonalPhone').value = selectedEmp.personalPhone || '';
            document.getElementById('editPersonalEmail').value = selectedEmp.personalEmail || '';
            document.getElementById('editWorkPhone').value = selectedEmp.workPhone || '';
            document.getElementById('editWorkEmail').value = selectedEmp.workEmail || '';
            document.getElementById('editJobTitle').value = selectedEmp.jobTitle || '';
            document.getElementById('editStartDate').value = selectedEmp.startDate || '';
            document.getElementById('editPaymentType').value = selectedEmp.paymentType || 'Monthly Salary';
            document.getElementById('editFullTimePay').value = selectedEmp.fullTimePay || '';
            document.getElementById('editModal').classList.add('active');
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.remove('active');
        }

        document.getElementById('editForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            if (!selectedEmp) return;

            const updated = {
                name: document.getElementById('editName').value.trim(),
                address: document.getElementById('editAddress').value.trim(),
                personalPhone: document.getElementById('editPersonalPhone').value.trim(),
                personalEmail: document.getElementById('editPersonalEmail').value.trim(),
                workPhone: document.getElementById('editWorkPhone').value.trim(),
                workEmail: document.getElementById('editWorkEmail').value.trim(),
                jobTitle: document.getElementById('editJobTitle').value.trim(),
                startDate: document.getElementById('editStartDate').value,
                paymentType: document.getElementById('editPaymentType').value,
                fullTimePay: document.getElementById('editFullTimePay').value.trim(),
            };

            try {
                await EMPLOYEES.update(selectedEmp.id, updated);
                alert('Employee updated!');
                closeEditModal();
                renderEmployeeList();
                selectEmployee(EMPLOYEES.data.find(e => e.id === selectedEmp.id));
            } catch (err) {
                alert("Update failed.");
            }
        });

        async function deleteEmployee() {
            if (!confirm("Delete this employee permanently?")) return;

            try {
                await EMPLOYEES.delete(selectedEmp.id);
                alert("Employee deleted.");
                closeEditModal();
                selectedEmp = null;
                document.getElementById('employeeDetails').innerHTML = `
                    <div class="no-employee">
                        <div class="no-employee-icon">Person</div>
                        <h3>No Employee Selected</h3>
                        <p>Please select an employee from the list above to view their details</p>
                    </div>
                `;
                renderEmployeeList();
            } catch (err) {
                alert("Delete failed.");
            }
        }

        // ────────────────────── 4. Search ──────────────────────
        function filterEmployees() {
            const term = document.getElementById('searchInput').value.trim().toLowerCase();
            document.querySelectorAll('.employee-item').forEach(item => {
                const text = item.textContent.toLowerCase();
                item.style.display = text.includes(term) ? 'block' : 'none';
            });
        }

        // ────────────────────── 5. ON LOAD ──────────────────────
        EMPLOYEES.onUpdate(() => {
            renderEmployeeList();
            if (selectedEmp) {
                const emp = EMPLOYEES.data.find(e => e.id === selectedEmp.id);
                if (emp) selectEmployee(emp);
            }
        });

        window.onload = function () {
            document.getElementById('employeeListContainer').innerHTML = '<p style="color:#666; text-align:center;">Loading employees...</p>';
            setTimeout(renderEmployeeList, 2000);
        };
    </script>
</body>
</html>
