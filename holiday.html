<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Holiday Booking | NGU-hrs</title>

    <!-- EMAILJS -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

    <style>
        * { margin:0; padding:0; box-sizing:border-box; }
        body { font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;
               background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
               min-height:100vh; padding:20px; }
        .container { max-width:1200px; margin:0 auto; }

        header { background:rgba(255,255,255,0.95); padding:25px 30px;
                 border-radius:15px; box-shadow:0 10px 30px rgba(0,0,0,0.2);
                 margin-bottom:30px; display:flex; justify-content:space-between;
                 align-items:center; }
        .header-left h1 { color:#667eea; font-size:2.2em; font-weight:700; }
        .header-left p { color:#666; margin-top:5px; }
        .back-btn { background:linear-gradient(135deg,#667eea,#764ba2);
                    color:white; padding:12px 25px; border:none; border-radius:8px;
                    cursor:pointer; font-size:1em; transition:transform .2s;
                    text-decoration:none; display:inline-block; }
        .back-btn:hover { transform:translateY(-2px);
                          box-shadow:0 5px 15px rgba(0,0,0,0.2); }

        .controls {
            background:rgba(255,255,255,0.95); padding:20px; border-radius:15px;
            box-shadow:0 8px 25px rgba(0,0,0,0.15); margin-bottom:25px;
            display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:15px;
        }
        .toggle-group {
            display:flex; gap:20px; flex-wrap:wrap;
        }
        .toggle-switch {
            display:flex; align-items:center; gap:10px; font-size:0.95em; color:#333;
        }
        .switch {
            position:relative; display:inline-block; width:50px; height:26px;
        }
        .switch input { opacity:0; width:0; height:0; }
        .slider {
            position:absolute; cursor:pointer; top:0; left:0; right:0; bottom:0;
            background:#ccc; transition:.4s; border-radius:34px;
        }
        .slider:before {
            position:absolute; content:""; height:18px; width:18px; left:4px; bottom:4px;
            background:white; transition:.4s; border-radius:50%;
        }
        input:checked + .slider { background:#28a745; }
        input:checked + .slider:before { transform:translateX(24px); }

        .search-section { background:rgba(255,255,255,0.95); padding:25px;
                          border-radius:15px; box-shadow:0 8px 25px rgba(0,0,0,0.15);
                          margin-bottom:25px; }
        .search-box { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
        .search-box input { flex:1; min-width:250px; padding:12px 20px;
                            border:2px solid #e0e0e0; border-radius:8px;
                            font-size:1em; transition:border .3s; }
        .search-box input:focus { outline:none; border-color:#667eea; }
        .search-btn {
            background:#667eea; color:white; border:none; padding:12px 20px;
            border-radius:8px; cursor:pointer; font-size:1em; display:flex;
            align-items:center; gap:8px; transition:all .3s;
        }
        .search-btn:hover { background:#5a6fd8; transform:translateY(-1px); }

        .content-area {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 25px;
        }

        .employee-list {
            background:rgba(255,255,255,0.95); padding:25px;
            border-radius:15px; box-shadow:0 8px 25px rgba(0,0,0,0.15);
            max-height:700px; overflow-y:auto;
        }
        .employee-list h2 { color:#333; margin-bottom:20px; font-size:1.3em; }
        .employee-item { background:#f8f9fa; padding:15px 20px; border-radius:8px;
                         margin-bottom:10px; cursor:pointer; transition:all .3s;
                         border-left:4px solid #667eea; }
        .employee-item.leaver { border-left-color:#dc3545; opacity:0.8; }
        .employee-item:hover { background:#e9ecef; transform:translateX(5px); }
        .employee-item.active { background:linear-gradient(135deg,rgba(102,126,234,.1),rgba(118,75,162,.1));
                                border-left-color:#764ba2; }
        .employee-item strong { display:block; color:#333; font-size:1.05em; margin-bottom:3px; }
        .employee-item span { color:#666; font-size:0.9em; }

        .booking-area {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        .holiday-stats {
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }
        .stat-box {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border-left: 4px solid #667eea;
        }
        .stat-number {
            font-size: 2em;
            font-weight: 700;
            color: #667eea;
            display: block;
        }
        .stat-label {
            color: #666;
            font-size: 0.9em;
            margin-top: 5px;
        }

        .booking-form {
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }
        .booking-form h2 {
            color: #333;
            margin-bottom: 25px;
            font-size: 1.5em;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        label {
            display: block;
            color: #333;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 0.95em;
        }
        input[type="date"],
        input[type="number"],
        textarea,
        select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: border 0.3s;
        }
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }
        textarea {
            resize: vertical;
            min-height: 100px;
        }
        .radio-group {
            display: flex;
            gap: 20px;
            margin-top: 8px;
            flex-wrap: wrap;
        }
        .radio-option {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }
        .radio-option input[type="radio"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        .radio-option label {
            margin: 0;
            cursor: pointer;
            font-weight: 500;
        }
        .working-days-display {
            background: #e7f3ff;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
            border-left: 4px solid #667eea;
        }
        .working-days-display strong {
            color: #667eea;
            font-size: 1.1em;
        }
        .btn-group {
            display: flex;
            gap: 15px;
            margin-top: 25px;
            flex-wrap: wrap;
        }
        .btn {
            padding: 14px 30px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            flex: 1;
        }
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        .info-box {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }
        .info-box p {
            color: #856404;
            margin: 0;
            font-size: 0.9em;
        }

        .request-list {
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }
        .request-item {
            background: #fff;
            padding: 18px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
        }
        .request-item.approved { border-left-color: #28a745; }
        .request-item.pending { border-left-color: #ffc107; }
        .request-item.rejected { border-left-color: #dc3545; }
        .request-main {
            flex: 1;
        }
        .request-type { font-weight: 700; color: #333; }
        .request-dates { color: #666; font-size: 0.95em; }
        .request-status {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            white-space: nowrap;
        }
        .status-approved { background: #d4edda; color: #155724; }
        .status-pending { background: #fff3cd; color: #856404; }
        .status-rejected { background: #f8d7da; color: #721c24; }
        .request-actions {
            display: flex;
            gap: 8px;
        }
        .request-actions button {
            background: none;
            border: none;
            font-size: 1.2em;
            cursor: pointer;
            padding: 6px;
            border-radius: 6px;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .request-actions button:hover { background: #f0f0f0; }
        .edit-btn { color: #667eea; }
        .delete-btn { color: #dc3545; }

        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e0e0e0;
        }
        .modal-header h2 {
            color: #667eea;
            font-size: 1.5em;
            margin: 0;
        }
        .close-modal {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #666;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .close-modal:hover { color: #dc3545; }

        @media (max-width: 968px) {
            .content-area { grid-template-columns: 1fr; }
            header { flex-direction: column; gap: 15px; text-align: center; }
            .form-row { grid-template-columns: 1fr; }
            .btn-group { flex-direction: column; }
            .btn-primary { flex: none; }
            .controls { flex-direction: column; align-items: stretch; }
            .search-box { flex-direction: column; }
            .search-btn { width: 100%; justify-content: center; }
        }
    </style>
</head>
<body>

    <!-- 1. FIREBASE FIRST -->
    <script type="module" src="employees-firebase.js"></script>

    <div class="container">
        <header>
            <div class="header-left">
                <h1>Holiday Booking</h1>
                <p>Request time off</p>
            </div>
            <a href="index.html" class="back-btn">Back to Dashboard</a>
        </header>

        <!-- TOGGLES -->
        <div class="controls">
            <div class="toggle-group">
                <div class="toggle-switch">
                    <label class="switch">
                        <input type="checkbox" id="showActive" onchange="renderEmployeeList()">
                        <span class="slider"></span>
                    </label>
                    <span>Show Active</span>
                </div>
                <div class="toggle-switch">
                    <label class="switch">
                        <input type="checkbox" id="showLeavers" onchange="renderEmployeeList()">
                        <span class="slider"></span>
                    </label>
                    <span>Show Leavers</span>
                </div>
            </div>
            <div style="color:#666; font-size:0.9em;">
                Active: <strong id="activeCount">0</strong> | 
                Leavers: <strong id="leaverCount">0</strong>
            </div>
        </div>

        <div class="search-section">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="Search by employee name or ID..." onkeyup="if(event.key==='Enter') filterEmployees()">
                <button class="search-btn" onclick="filterEmployees()">Search</button>
            </div>
        </div>

        <div class="content-area">
            <!-- Employee List -->
            <div class="employee-list">
                <h2>Employees</h2>
                <div id="employeeListContainer">
                    <p style="color:#666; text-align:center;">Loading employees...</p>
                </div>
            </div>

            <!-- Booking Area -->
            <div class="booking-area">
                <div id="noSelection" style="text-align:center; padding:60px; color:#666;">
                    <h3>No Employee Selected</h3>
                    <p>Select an employee to book holiday</p>
                </div>

                <div id="bookingSection" style="display:none;">
                    <div class="holiday-stats">
                        <h2 style="color:#333; margin-bottom:15px;">Holiday Allowance</h2>
                        <div class="stats-grid">
                            <div class="stat-box">
                                <span class="stat-number" id="totalEntitlement">0</span>
                                <span class="stat-label">Total Entitlement</span>
                            </div>
                            <div class="stat-box">
                                <span class="stat-number" id="daysTaken">0</span>
                                <span class="stat-label">Days Taken</span>
                            </div>
                            <div class="stat-box">
                                <span class="stat-number" id="daysRequested">0</span>
                                <span class="stat-label">Days Requested</span>
                            </div>
                            <div class="stat-box">
                                <span class="stat-number" id="daysRemaining">0</span>
                                <span class="stat-label">Days Remaining</span>
                            </div>
                        </div>
                    </div>

                    <div class="booking-form">
                        <h2>Book Holiday</h2>
                        <form id="holidayForm">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="dateFrom">Date From *</label>
                                    <input type="date" id="dateFrom" required onchange="calculateWorkingDays()">
                                </div>
                                <div class="form-group">
                                    <label for="dateTo">Date To *</label>
                                    <input type="date" id="dateTo" required onchange="calculateWorkingDays()">
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="workingDays">Working Days *</label>
                                <input type="number" id="workingDays" step="0.5" min="0.5" required>
                                <div class="working-days-display" id="calculatedDays" style="display:none;">
                                    Calculated: <strong id="calculatedValue">0</strong> working days
                                </div>
                            </div>

                            <div class="form-group">
                                <label>Holiday Type *</label>
                                <div class="radio-group">
                                    <div class="radio-option">
                                        <input type="radio" id="fullDay" name="holidayType" value="Full Day" checked>
                                        <label for="fullDay">Full Day</label>
                                    </div>
                                    <div class="radio-option">
                                        <input type="radio" id="morningOnly" name="holidayType" value="Morning Only">
                                        <label for="morningOnly">Morning Only</label>
                                    </div>
                                    <div class="radio-option">
                                        <input type="radio" id="afternoonOnly" name="holidayType" value="Afternoon Only">
                                        <label for="afternoonOnly">Afternoon Only</label>
                                    </div>
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="notes">Notes</label>
                                <textarea id="notes" placeholder="Add any additional information..."></textarea>
                            </div>

                            <div class="info-box">
                                <p>All holiday requests are subject to manager approval. You will receive a notification once reviewed.</p>
                            </div>

                            <div class="btn-group">
                                <button type="submit" class="btn btn-primary">Submit Request</button>
                                <button type="reset" class="btn btn-secondary" onclick="resetForm()">Clear Form</button>
                            </div>
                        </form>
                    </div>

                    <div class="request-list">
                        <h3 style="color:#333; margin-bottom:20px;">Your Holiday Requests</h3>
                        <div id="requestList"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Edit Modal -->
        <div id="editModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Edit Holiday Request</h2>
                    <button class="close-modal" onclick="closeEditModal()">X</button>
                </div>
                <form id="editForm">
                    <input type="hidden" id="editIndex">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editDateFrom">From *</label>
                            <input type="date" id="editDateFrom" required>
                        </div>
                        <div class="form-group">
                            <label for="editDateTo">To *</label>
                            <input type="date" id="editDateTo" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="editDays">Days *</label>
                        <input type="number" id="editDays" step="0.5" min="0.5" required>
                    </div>
                    <div class="form-group">
                        <label for="editType">Type</label>
                        <select id="editType">
                            <option value="Full Day">Full Day</option>
                            <option value="Morning Only">Morning Only</option>
                            <option value="Afternoon Only">Afternoon Only</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editNotes">Notes</label>
                        <textarea id="editNotes"></textarea>
                    </div>
                    <div class="btn-group">
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                        <button type="button" class="btn btn-danger" onclick="deleteRequest()">Delete</button>
                        <button type="button" class="btn btn-secondary" onclick="closeEditModal()">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        let selectedEmployeeId = null;
        let currentEditIndex = -1;

        // EMAIL CONFIG
        const EMAILJS_SERVICE_ID = 'service_9dr2ws7';
        const EMAILJS_TEMPLATE_ID = 'template_cpujhfa';
        const EMAILJS_PUBLIC_KEY = 'ziLnha91scpGjFABh';
        const MANAGERS = [
            'barry.dixon@next-gen.uk',
            'Marie.Wall@next-gen.uk',
            'Carl.Finnigan@next-gen.uk',
            'ashleigh.ginks@next-gen.uk',
            'Maia.foster@next-gen.uk',
            'Rebecca.Salter@next-gen.uk'
        ];
        emailjs.init(EMAILJS_PUBLIC_KEY);

        // ────────────────────── 1. Render Employee List ──────────────────────
        function renderEmployeeList() {
            const container = document.getElementById('employeeListContainer');
            const showActive = document.getElementById('showActive').checked;
            const showLeavers = document.getElementById('showLeavers').checked;

            const active = EMPLOYEES.data.filter(e => !e.dateLeft);
            const leavers = EMPLOYEES.data.filter(e => e.dateLeft);

            document.getElementById('activeCount').textContent = active.length;
            document.getElementById('leaverCount').textContent = leavers.length;

            let employeesToShow = [];
            if (showActive && showLeavers) employeesToShow = EMPLOYEES.data;
            else if (showActive) employeesToShow = active;
            else if (showLeavers) employeesToShow = leavers;

            if (!employeesToShow.length) {
                container.innerHTML = '<p style="color:#666; text-align:center;">No employees</p>';
                return;
            }

            container.innerHTML = '';
            employeesToShow.forEach(emp => {
                const item = document.createElement('div');
                item.className = `employee-item ${emp.dateLeft ? 'leaver' : ''}`;
                item.onclick = () => selectEmployee(emp.id);
                item.innerHTML = `<strong>${emp.name}</strong><span>ID: ${emp.id}</span>`;
                container.appendChild(item);
            });
        }

        // ────────────────────── 2. Select Employee ──────────────────────
        function selectEmployee(id) {
            selectedEmployeeId = id;
            const emp = EMPLOYEES.data.find(e => e.id === id);
            if (!emp) return;

            document.querySelectorAll('.employee-item').forEach(i => i.classList.remove('active'));
            const activeItem = document.querySelector(`.employee-item[onclick="selectEmployee('${id}')"]`);
            if (activeItem) activeItem.classList.add('active');

            document.getElementById('noSelection').style.display = 'none';
            document.getElementById('bookingSection').style.display = 'block';

            loadEmployeeData(emp);
        }

        function loadEmployeeData(emp) {
            const entitlement = emp.holidayEntitlement || 28;
            const taken = (emp.holidays || []).filter(r => r.status === 'approved').reduce((s, r) => s + parseFloat(r.days), 0);
            const requested = (emp.holidays || []).filter(r => r.status === 'pending').reduce((s, r) => s + parseFloat(r.days), 0);
            const remaining = entitlement - taken - requested;

            document.getElementById('totalEntitlement').textContent = entitlement;
            document.getElementById('daysTaken').textContent = taken;
            document.getElementById('daysRequested').textContent = requested;
            document.getElementById('daysRemaining').textContent = remaining;

            displayRequests(emp.holidays || []);
        }

        // ────────────────────── 3. Display Requests ──────────────────────
        function displayRequests(records) {
            const container = document.getElementById('requestList');
            if (!records.length) {
                container.innerHTML = '<p style="color:#666; text-align:center; padding:30px;">No holiday requests</p>';
                return;
            }

            let html = '';
            records.forEach((r, idx) => {
                const date = new Date(r.submittedAt || Date.now()).toLocaleDateString('en-GB');
                html += `
                    <div class="request-item ${r.status}">
                        <div class="request-main">
                            <div class="request-type">${r.type || 'Full Day'}</div>
                            <div class="request-dates">${formatDate(r.dateFrom)} - ${formatDate(r.dateTo)} • ${r.days} days</div>
                            <div style="margin-top:5px; font-size:0.9em; color:#666;">
                                Submitted: ${date}
                                ${r.notes ? `<br><em>${r.notes}</em>` : ''}
                            </div>
                        </div>
                        <div class="request-actions">
                            <button class="edit-btn" onclick="openEditModal(${idx})" title="Edit">Edit</button>
                            <button class="delete-btn" onclick="deleteRequest(${idx})" title="Delete">Delete</button>
                        </div>
                    </div>`;
            });
            container.innerHTML = html;
        }

        function formatDate(str) {
            const d = new Date(str);
            return d.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
        }

        // ────────────────────── 4. Submit Request ──────────────────────
        document.getElementById('holidayForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const emp = EMPLOYEES.data.find(e => e.id === selectedEmployeeId);
            if (!emp.holidays) emp.holidays = [];

            const request = {
                dateFrom: document.getElementById('dateFrom').value,
                dateTo: document.getElementById('dateTo').value,
                days: parseFloat(document.getElementById('workingDays').value),
                type: document.querySelector('input[name="holidayType"]:checked').value,
                notes: document.getElementById('notes').value,
                status: 'pending',
                submittedAt: new Date().toISOString()
            };

            emp.holidays.push(request);

            try {
                await EMPLOYEES.update(emp.id, { holidays: emp.holidays });
                alert("Holiday request submitted!");
                await sendEmail(emp, request, "submitted");
                resetForm();
                loadEmployeeData(emp);
            } catch (err) {
                alert("Failed to submit.");
            }
        });

        async function sendEmail(emp, rec, action) {
            const templateParams = {
                employee_name: emp.name,
                employee_id: emp.id,
                type: rec.type,
                date_from: rec.dateFrom,
                date_to: rec.dateTo,
                days: rec.days,
                status: rec.status.charAt(0).toUpperCase() + rec.status.slice(1),
                notes: rec.notes || '—',
                action: action,
                remaining_days: (emp.holidayEntitlement || 28) - 
                    emp.holidays.filter(r => r.status === 'approved').reduce((s, r) => s + parseFloat(r.days), 0) -
                    emp.holidays.filter(r => r.status === 'pending').reduce((s, r) => s + parseFloat(r.days), 0)
            };

            await Promise.all(MANAGERS.map(email =>
                emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, { ...templateParams, to_email: email })
            )).catch(() => {});
        }

        // ────────────────────── 5. Edit/Delete Modal ──────────────────────
        function openEditModal(index) {
            currentEditIndex = index;
            const rec = EMPLOYEES.data.find(e => e.id === selectedEmployeeId).holidays[index];
            document.getElementById('editDateFrom').value = rec.dateFrom;
            document.getElementById('editDateTo').value = rec.dateTo;
            document.getElementById('editDays').value = rec.days;
            document.getElementById('editType').value = rec.type;
            document.getElementById('editNotes').value = rec.notes || '';
            document.getElementById('editModal').classList.add('active');
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.remove('active');
            currentEditIndex = -1;
        }

        document.getElementById('editForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            if (currentEditIndex === -1) return;

            const emp = EMPLOYEES.data.find(e => e.id === selectedEmployeeId);
            const rec = {
                ...emp.holidays[currentEditIndex],
                dateFrom: document.getElementById('editDateFrom').value,
                dateTo: document.getElementById('editDateTo').value,
                days: parseFloat(document.getElementById('editDays').value),
                type: document.getElementById('editType').value,
                notes: document.getElementById('editNotes').value
            };

            emp.holidays[currentEditIndex] = rec;

            try {
                await EMPLOYEES.update(emp.id, { holidays: emp.holidays });
                alert("Request updated!");
                await sendEmail(emp, rec, "edited");
                closeEditModal();
                loadEmployeeData(emp);
            } catch (err) {
                alert("Update failed.");
            }
        });

        async function deleteRequest(index = currentEditIndex) {
            if (!confirm("Delete this request?")) return;

            const emp = EMPLOYEES.data.find(e => e.id === selectedEmployeeId);
            const rec = emp.holidays[index];
            emp.holidays.splice(index, 1);

            try {
                await EMPLOYEES.update(emp.id, { holidays: emp.holidays });
                alert("Request deleted!");
                await sendEmail(emp, rec, "deleted");
                closeEditModal();
                loadEmployeeData(emp);
            } catch (err) {
                alert("Delete failed.");
            }
        }

        // ────────────────────── 6. Helpers ──────────────────────
        function calculateWorkingDays() {
            const from = document.getElementById('dateFrom').value;
            const to = document.getElementById('dateTo').value;
            if (!from || !to) return;

            const start = new Date(from);
            const end = new Date(to);
            if (end < start) { alert("End date must be after start"); return; }

            let days = 0;
            let current = new Date(start);
            while (current <= end) {
                const d = current.getDay();
                if (d !== 0 && d !== 6) days++;
                current.setDate(current.getDate() + 1);
            }

            document.getElementById('calculatedValue').textContent = days;
            document.getElementById('calculatedDays').style.display = 'block';
            document.getElementById('workingDays').value = days;
        }

        function resetForm() {
            document.getElementById('holidayForm').reset();
            document.getElementById('calculatedDays').style.display = 'none';
        }

        function filterEmployees() {
            const term = document.getElementById('searchInput').value.trim().toLowerCase();
            document.querySelectorAll('.employee-item').forEach(item => {
                const text = item.textContent.toLowerCase();
                item.style.display = text.includes(term) ? 'block' : 'none';
            });
        }

        // ────────────────────── 7. ON LOAD ──────────────────────
        EMPLOYEES.onUpdate(() => {
            renderEmployeeList();
            if (selectedEmployeeId) {
                const emp = EMPLOYEES.data.find(e => e.id === selectedEmployeeId);
                if (emp) loadEmployeeData(emp);
            }
        });

        window.onload = function () {
            setTimeout(renderEmployeeList, 2000);
        };
    </script>
</body>
</html>
