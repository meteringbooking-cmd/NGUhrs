<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attendance Breakdown | NGU-hrs</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box;}
        body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;padding:20px;}
        .container{max-width:100%;margin:0 auto;background:white;border-radius:15px;padding:30px;box-shadow:0 10px 30px rgba(0,0,0,.2);}
        .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:30px;padding-bottom:20px;border-bottom:3px solid #667eea;flex-wrap:wrap;gap:10px;}
        .header-left{display:flex;align-items:center;gap:15px;flex-wrap:wrap;}
        h1{color:#667eea;font-size:2.5em;}
        .month-selector{display:flex;gap:10px;align-items:center;}
        .month-selector select{padding:8px 12px;border:2px solid #667eea;border-radius:8px;font-size:1em;cursor:pointer;}
        .back-btn,.export-btn{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;padding:12px 24px;border:none;border-radius:8px;cursor:pointer;font-size:1em;transition:all .3s ease;text-decoration:none;display:inline-block;}
        .back-btn:hover,.export-btn:hover{transform:translateY(-2px);box-shadow:0 5px 15px rgba(102,126,234,.4);}
        .export-btn{background:linear-gradient(135deg,#28a745 0%,#20c997 100%);}
        .table-container{overflow-x:auto;margin-top:20px;}
        table{width:100%;border-collapse:collapse;font-size:.85em;}
        th{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;padding:12px 8px;text-align:center;font-weight:600;position:sticky;top:0;z-index:10;border:1px solid #5568d3;}
        th.name-header,th.cost-header{text-align:left;min-width:120px;}
        th.cost-header{min-width:100px;}
        th.date-header{min-width:50px;}
        td{padding:10px 8px;text-align:center;border:1px solid #ddd;cursor:pointer;transition:background .2s;}
        td:hover:not(.name-cell):not(.cost-cell):not(.holiday-cell):not(.payment-cell){background:#e3e7ff;}
        td.name-cell{text-align:left;font-weight:500;background:#f8f9fa;cursor:default;}
        td.cost-cell{text-align:right;font-weight:bold;background:#fff3cd;color:#856404;cursor:default;}
        td.payment-cell{text-align:right;font-weight:bold;background:#e3f2fd;color:#1565c0;cursor:default;}
        td.holiday-cell{text-align:center;font-weight:bold;background:#d1ecf1;color:#0c5460;cursor:default;}
        tr:nth-child(even){background-color:#f9f9f9;}
        tr:hover{background-color:#f0f0f0;}
        .status-X{color:#28a745;font-weight:bold;}
        .status-H{color:#ff9800;font-weight:bold;}
        .status-Sick{color:#dc3545;font-weight:bold;}
        .status-AAUP{color:#6c757d;font-weight:bold;}
        .status-NPT{color:#17a2b8;font-weight:bold;}
        .status-AWOL{color:#e83e8c;font-weight:bold;}
        .status-baby{color:#9c27b0;font-weight:bold;}
        .status-TOFD{color:#fd7e14;font-weight:bold;}
        .day-row{background:#e3e7ff !important;font-weight:600;font-size:.8em;}
        .legend{display:flex;gap:20px;flex-wrap:wrap;margin-top:20px;padding:15px;background:#f8f9fa;border-radius:8px;}
        .legend-item{display:flex;align-items:center;gap:8px;}
        .legend-color{width:20px;height:20px;border-radius:4px;font-weight:bold;display:flex;align-items:center;justify-content:center;font-size:.8em;}
        .loading{text-align:center;padding:40px;color:#666;font-size:1.2em;}
        .status-modal{display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:white;padding:20px;border-radius:10px;box-shadow:0 10px 40px rgba(0,0,0,.3);z-index:1000;}
        .status-modal.active{display:block;}
        .modal-overlay{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);z-index:999;}
        .modal-overlay.active{display:block;}
        .status-buttons{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-top:15px;}
        .status-btn{padding:10px;border:none;border-radius:6px;cursor:pointer;font-weight:600;transition:all .2s;}
        .status-btn:hover{transform:translateY(-2px);}
        .status-btn.present{background:#d4edda;color:#155724;}
        .status-btn.holiday{background:#fff3cd;color:#856404;}
        .status-btn.sick{background:#f8d7da;color:#721c24;}
        .status-btn.aaup{background:#e2e3e5;color:#383d41;}
        .status-btn.npt{background:#d1ecf1;color:#0c5460;}
        .status-btn.awol{background:#f5c6cb;color:#721c24;}
        .status-btn.baby{background:#e2d9f3;color:#4a148c;}
        .status-btn.tofd{background:#ffe5cc;color:#8b4513;}
        .status-btn.clear{background:#f8f9fa;color:#333;}
    </style>
</head>
<body>
    <script type="module" src="employees-firebase.js"></script>
    <div class="container">
        <div class="header">
            <div class="header-left">
                <h1 id="pageTitle">Attendance Breakdown</h1>
                <div class="month-selector">
                    <label for="monthSelect">Month:</label>
                    <select id="monthSelect" onchange="changeMonth()"></select>
                    <label for="yearSelect">Year:</label>
                    <select id="yearSelect" onchange="changeMonth()"></select>
                </div>
            </div>
            <div>
                <button class="export-btn" onclick="exportToCSV()">Export to CSV</button>
                <a href="index.html" class="back-btn">Back to Dashboard</a>
            </div>
        </div>

        <div class="legend">
            <div class="legend-item"><div class="legend-color status-X">X</div><span>Present</span></div>
            <div class="legend-item"><div class="legend-color status-H">H</div><span>Holiday</span></div>
            <div class="legend-item"><div class="legend-color status-Sick">Sick</div><span>Sick Leave</span></div>
            <div class="legend-item"><div class="legend-color status-AAUP">AAUP</div><span>Authorized Absence Unpaid</span></div>
            <div class="legend-item"><div class="legend-color status-NPT">NPT</div><span>None Productive Time</span></div>
            <div class="legend-item"><div class="legend-color status-AWOL">AWOL</div><span>Absent Without Leave</span></div>
            <div class="legend-item"><div class="legend-color status-baby">baby</div><span>Maternity/Paternity</span></div>
            <div class="legend-item"><div class="legend-color status-TOFD">TOFD</div><span>Time Off For Dependents</span></div>
        </div>

        <div class="table-container">
            <div id="loadingMessage" class="loading">Loading attendance data...</div>
            <table id="attendanceTable" style="display:none;">
                <thead id="tableHeader"></thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>

    <div class="modal-overlay" id="modalOverlay" onclick="closeStatusModal()"></div>
    <div class="status-modal" id="statusModal">
        <h3 id="modalTitle">Set Attendance Status</h3>
        <div class="status-buttons">
            <button class="status-btn present" onclick="setStatus('X')">Present (X)</button>
            <button class="status-btn holiday" onclick="setStatus('H')">Holiday (H)</button>
            <button class="status-btn sick" onclick="setStatus('Sick')">Sick</button>
            <button class="status-btn aaup" onclick="setStatus('AAUP')">AAUP</button>
            <button class="status-btn npt" onclick="setStatus('NPT')">NPT</button>
            <button class="status-btn awol" onclick="setStatus('AWOL')">AWOL</button>
            <button class="status-btn baby" onclick="setStatus('baby')">Maternity/Paternity</button>
            <button class="status-btn tofd" onclick="setStatus('TOFD')">TOFD</button>
            <button class="status-btn clear" onclick="setStatus('')">Clear</button>
        </div>
    </div>

    <script>
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();
        let attendanceData = {};
        let currentCell = null;
        let allClaims = [];
        const HOURLY_RATE = 19.23;

        async function loadPaymentClaims() {
            try {
                const { getFirestore, collection, onSnapshot } = await import('https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js');
                const db = getFirestore();
                const claimsCollection = collection(db, 'additionalPaymentClaims');

                onSnapshot(claimsCollection, (snapshot) => {
                    allClaims = [];
                    snapshot.forEach(doc => {
                        allClaims.push({ id: doc.id, ...doc.data() });
                    });
                    if (window.EMPLOYEES && window.EMPLOYEES.data && window.EMPLOYEES.data.length > 0) {
                        loadAttendanceData();
                    }
                });
            } catch (error) {
                console.error('Error loading payment claims:', error);
            }
        }

        function initializeSelectors() {
            const monthSelect = document.getElementById('monthSelect');
            const yearSelect = document.getElementById('yearSelect');
            const months = ['January','February','March','April','May','June','July','August','September','October','November','December'];

            months.forEach((m,i) => {
                const o = document.createElement('option');
                o.value = i;
                o.textContent = m;
                if (i === currentMonth) o.selected = true;
                monthSelect.appendChild(o);
            });

            for (let y = 2024; y <= 2030; y++) {
                const o = document.createElement('option');
                o.value = y;
                o.textContent = y;
                if (y === currentYear) o.selected = true;
                yearSelect.appendChild(o);
            }
        }

        function changeMonth() {
            currentMonth = +document.getElementById('monthSelect').value;
            currentYear = +document.getElementById('yearSelect').value;
            loadAttendanceData();
        }

        function getDaysInMonth(m, y) { return new Date(y, m + 1, 0).getDate(); }
        function getDayName(d) { return ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][d.getDay()]; }
        function isWeekend(d) { return d.getDay() === 0 || d.getDay() === 6; }
        function isWorkingDay(d) { return !isWeekend(d); }
        function isPastOrToday(d) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const check = new Date(d);
            check.setHours(0, 0, 0, 0);
            return check <= today;
        }
        function isDateInRange(check, start, end) {
            const c = new Date(check), s = new Date(start), e = new Date(end);
            [c, s, e].forEach(x => x.setHours(0, 0, 0, 0));
            return c >= s && c <= e;
        }

        function generateTableHeaders() {
            const days = getDaysInMonth(currentMonth, currentYear);
            const monthName = new Date(currentYear, currentMonth).toLocaleString('default', { month: 'long' });
            document.getElementById('pageTitle').textContent = `Attendance Breakdown - ${monthName} ${currentYear}`;

            let html = `<tr>
                <th class="name-header">Name</th>
                <th class="cost-header">Absence Cost</th>
                <th class="cost-header">Holiday Days</th>
                <th class="cost-header">Standby £</th>
                <th class="cost-header">Overtime £</th>
                <th class="cost-header">Jobs £</th>`;

            for (let d = 1; d <= days; d++) {
                const date = new Date(currentYear, currentMonth, d);
                if (!isWeekend(date)) html += `<th class="date-header">${String(d).padStart(2, '0')}-${monthName.substring(0, 3)}</th>`;
            }
            html += `</tr>`;

            html += `<tr class="day-row"><td></td><td></td><td></td><td></td><td></td><td></td>`;
            for (let d = 1; d <= days; d++) {
                const date = new Date(currentYear, currentMonth, d);
                if (!isWeekend(date)) html += `<td>${getDayName(date)}</td>`;
            }
            html += `</tr>`;

            document.getElementById('tableHeader').innerHTML = html;
        }

        function calculateHolidayDays(empId) {
            let count = 0;
            const days = getDaysInMonth(currentMonth, currentYear);
            const emp = window.EMPLOYEES.data.find(e => e.id === empId);

            for (let d = 1; d <= days; d++) {
                const date = new Date(currentYear, currentMonth, d);
                if (isWeekend(date)) continue;
                const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                const key = `${empId}_${dateStr}`;
                let status = attendanceData[key] || '';

                if (!status && emp.holidays) {
                    const hol = emp.holidays.find(h => h.status === 'approved' && isDateInRange(date, h.dateFrom, h.dateTo));
                    if (hol) status = 'H';
                }
                if (status === 'H') count++;
            }
            return count;
        }

        function calculateAbsenceCost(empId) {
            let totalHours = 0;
            const emp = window.EMPLOYEES.data.find(e => e.id === empId);

            if (emp.absences && emp.absences.length > 0) {
                emp.absences.forEach(abs => {
                    const absStart = new Date(abs.dateFrom);
                    const absEnd = new Date(abs.dateTo);
                    const monthStart = new Date(currentYear, currentMonth, 1);
                    const monthEnd = new Date(currentYear, currentMonth + 1, 0);

                    if (absStart <= monthEnd && absEnd >= monthStart) {
                        if (['sickness', 'aaup', 'tofd'].includes(abs.type)) {
                            const hours = parseFloat(abs.hours);
                            if (!isNaN(hours) && hours > 0) {
                                totalHours += hours;
                            }
                        }
                    }
                });
            }

            return totalHours * HOURLY_RATE;
        }

        function calculatePaymentTotals(empId) {
            let standbyTotal = 0;
            let overtimeTotal = 0;
            let jobsTotal = 0;

            const employeeClaims = allClaims.filter(claim => {
                if (claim.employeeId !== empId) return false;
                
                const claimDate = new Date(claim.date);
                return claimDate.getMonth() === currentMonth && claimDate.getFullYear() === currentYear;
            });

            employeeClaims.forEach(claim => {
                standbyTotal += claim.standbyValue || 0;
                overtimeTotal += claim.overtimeValue || 0;
                jobsTotal += claim.jobsTotalValue || 0;
            });

            return { standbyTotal, overtimeTotal, jobsTotal };
        }

        async function loadAttendanceData() {
            document.getElementById('loadingMessage').style.display = 'block';
            document.getElementById('attendanceTable').style.display = 'none';

            if (!window.EMPLOYEES || !window.EMPLOYEES.data || window.EMPLOYEES.data.length === 0) {
                setTimeout(loadAttendanceData, 500);
                return;
            }

            const activeEmployees = window.EMPLOYEES.data
                .filter(e => !e.dateLeft)
                .sort((a, b) => a.name.localeCompare(b.name));

            const days = getDaysInMonth(currentMonth, currentYear);
            generateTableHeaders();

            let bodyHTML = '';
            activeEmployees.forEach(emp => {
                bodyHTML += `<tr>
                    <td class="name-cell">${emp.name}</td>`;

                const absenceCost = calculateAbsenceCost(emp.id);
                bodyHTML += `<td class="cost-cell">${absenceCost > 0 ? '£' + absenceCost.toFixed(2) : ''}</td>`;

                const holidayDays = calculateHolidayDays(emp.id);
                bodyHTML += `<td class="holiday-cell">${holidayDays > 0 ? holidayDays : ''}</td>`;

                const payments = calculatePaymentTotals(emp.id);
                bodyHTML += `<td class="payment-cell">${payments.standbyTotal > 0 ? '£' + payments.standbyTotal.toFixed(2) : ''}</td>`;
                bodyHTML += `<td class="payment-cell">${payments.overtimeTotal > 0 ? '£' + payments.overtimeTotal.toFixed(2) : ''}</td>`;
                bodyHTML += `<td class="payment-cell">${payments.jobsTotal > 0 ? '£' + payments.jobsTotal.toFixed(2) : ''}</td>`;

                for (let d = 1; d <= days; d++) {
                    const date = new Date(currentYear, currentMonth, d);
                    if (isWeekend(date)) continue;

                    const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                    let status = '';
                    let statusClass = '';

                    if (emp.holidays) {
                        const hol = emp.holidays.find(h => h.status === 'approved' && isDateInRange(date, h.dateFrom, h.dateTo));
                        if (hol) {
                            status = 'H';
                            statusClass = 'status-H';
                        }
                    }

                    if (!status && emp.absences) {
                        const abs = emp.absences.find(a => isDateInRange(date, a.dateFrom, a.dateTo));
                        if (abs) {
                            if (abs.type === 'sickness') { status = 'Sick'; statusClass = 'status-Sick'; }
                            else if (abs.type === 'aaup') { status = 'AAUP'; statusClass = 'status-AAUP'; }
                            else if (abs.type === 'tofd') { status = 'TOFD'; statusClass = 'status-TOFD'; }
                        }
                    }

                    const key = `${empId}_${dateStr}`;
                    if (attendanceData[key]) {
                        status = attendanceData[key];
                        statusClass = `status-${status}`;
                    }

                    if (!status && isWorkingDay(date) && isPastOrToday(date)) {
                        status = 'X';
                        statusClass = 'status-X';
                    }

                    bodyHTML += `<td class="${statusClass}" onclick="openStatusModal('${emp.id}','${dateStr}',this)">${status}</td>`;
                }
                bodyHTML += `</tr>`;
            });

            document.getElementById('tableBody').innerHTML = bodyHTML;
            document.getElementById('loadingMessage').style.display = 'none';
            document.getElementById('attendanceTable').style.display = 'table';
        }

        function openStatusModal(empId, date, cell) {
            currentCell = { empId, date, cell };
            const emp = window.EMPLOYEES.data.find(e => e.id === empId);
            const d = new Date(date);
            const dateStr = d.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
            document.getElementById('modalTitle').textContent = `${emp.name} - ${dateStr}`;
            document.getElementById('statusModal').classList.add('active');
            document.getElementById('modalOverlay').classList.add('active');
        }

        function closeStatusModal() {
            document.getElementById('statusModal').classList.remove('active');
            document.getElementById('modalOverlay').classList.remove('active');
            currentCell = null;
        }

        function setStatus(status) {
            if (!currentCell) return;
            const { empId, date, cell } = currentCell;
            const key = `${empId}_${date}`;

            if (status === '') {
                delete attendanceData[key];
                const d = new Date(date);
                if (isWorkingDay(d) && isPastOrToday(d)) {
                    cell.textContent = 'X';
                    cell.className = 'status-X';
                } else {
                    cell.textContent = '';
                    cell.className = '';
                }
            } else {
                attendanceData[key] = status;
                cell.textContent = status;
                cell.className = `status-${status}`;
            }

            localStorage.setItem('attendanceData', JSON.stringify(attendanceData));

            const row = cell.parentElement;
            const absenceCost = calculateAbsenceCost(empId);
            row.cells[1].textContent = absenceCost > 0 ? '£' + absenceCost.toFixed(2) : '';
            const holidayDays = calculateHolidayDays(empId);
            row.cells[2].textContent = holidayDays > 0 ? holidayDays : '';

            closeStatusModal();
        }

        function exportToCSV() {
            const table = document.getElementById('attendanceTable');
            const rows = table.querySelectorAll('tr');
            const csv = [];

            rows.forEach(r => {
                const cols = r.querySelectorAll('td, th');
                const line = Array.from(cols).map(c => `"${(c.innerText || '').replace(/"/g, '""')}"`).join(',');
                csv.push(line);
            });

            const monthName = new Date(currentYear, currentMonth).toLocaleString('default', { month: 'long' });
            const blob = new Blob([csv.join('\n')], { type: 'text/csv;charset=utf-8;' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `attendance_${monthName}_${currentYear}.csv`;
            a.style.display = 'none';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        window.onload = () => {
            initializeSelectors();
            const saved = localStorage.getItem('attendanceData');
            if (saved) attendanceData = JSON.parse(saved);

            loadPaymentClaims();

            if (window.EMPLOYEES) window.EMPLOYEES.onUpdate(loadAttendanceData);
            setTimeout(loadAttendanceData, 1000);
        };
    </script>
</body>
</html>
