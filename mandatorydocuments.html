<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mandatory Documents | NGU-hrs</title>
    <style>
        * { margin:0; padding:0; box-sizing:border-box; }
        body { font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;
               background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
               min-height:100vh; padding:20px; }
        .container { max-width:1400px; margin:0 auto; }

        header { background:rgba(255,255,255,0.95); padding:25px 30px;
                 border-radius:15px; box-shadow:0 10px 30px rgba(0,0,0,0.2);
                 margin-bottom:30px; display:flex; justify-content:space-between;
                 align-items:center; }
        .header-left h1 { color:#667eea; font-size:2.2em; font-weight:700; }
        .header-left p { color:#666; margin-top:5px; }
        .back-btn { background:linear-gradient(135deg,#667eea,#764ba2);
                    color:white; padding:12px 25px; border:none; border-radius:8px;
                    cursor:pointer; font-size:1em; transition:transform .2s;
                    text-decoration:none; display:inline-block; }
        .back-btn:hover { transform:translateY(-2px);
                          box-shadow:0 5px 15px rgba(0,0,0,0.2); }

        .controls {
            background:rgba(255,255,255,0.95); padding:20px; border-radius:15px;
            box-shadow:0 8px 25px rgba(0,0,0,0.15); margin-bottom:25px;
            display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:15px;
        }
        .toggle-group {
            display:flex; gap:20px; flex-wrap:wrap;
        }
        .toggle-switch {
            display:flex; align-items:center; gap:10px; font-size:0.95em; color:#333;
        }
        .switch {
            position:relative; display:inline-block; width:50px; height:26px;
        }
        .switch input { opacity:0; width:0; height:0; }
        .slider {
            position:absolute; cursor:pointer; top:0; left:0; right:0; bottom:0;
            background:#ccc; transition:.4s; border-radius:34px;
        }
        .slider:before {
            position:absolute; content:""; height:18px; width:18px; left:4px; bottom:4px;
            background:white; transition:.4s; border-radius:50%;
        }
        input:checked + .slider { background:#28a745; }
        input:checked + .slider:before { transform:translateX(24px); }

        .search-section { background:rgba(255,255,255,0.95); padding:25px;
                          border-radius:15px; box-shadow:0 8px 25px rgba(0,0,0,0.15);
                          margin-bottom:25px; }
        .search-box { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
        .search-box input { flex:1; min-width:250px; padding:12px 20px;
                            border:2px solid #e0e0e0; border-radius:8px;
                            font-size:1em; transition:border .3s; }
        .search-box input:focus { outline:none; border-color:#667eea; }
        .search-btn {
            background:#667eea; color:white; border:none; padding:12px 20px;
            border-radius:8px; cursor:pointer; font-size:1em; display:flex;
            align-items:center; gap:8px; transition:all .3s;
        }
        .search-btn:hover { background:#5a6fd8; transform:translateY(-1px); }

        .content-area { display:grid; grid-template-columns:350px 1fr; gap:25px; }
        .employee-list { background:rgba(255,255,255,0.95); padding:25px;
                         border-radius:15px; box-shadow:0 8px 25px rgba(0,0,0,0.15);
                         max-height:700px; overflow-y:auto; }
        .employee-list h2 { color:#333; margin-bottom:20px; font-size:1.3em; }
        .employee-item { background:#f8f9fa; padding:15px 20px; border-radius:8px;
                         margin-bottom:10px; cursor:pointer; transition:all .3s;
                         border-left:4px solid #667eea; }
        .employee-item.leaver { border-left-color:#dc3545; opacity:0.8; }
        .employee-item:hover { background:#e9ecef; transform:translateX(5px); }
        .employee-item.active { background:linear-gradient(135deg,rgba(102,126,234,.1),rgba(118,75,162,.1));
                                border-left-color:#764ba2; }
        .employee-item strong { display:block; color:#333; font-size:1.05em; margin-bottom:3px; }
        .employee-item span { color:#666; font-size:0.9em; }

        .documents-area { background:rgba(255,255,255,0.95); padding:30px;
                        border-radius:15px; box-shadow:0 8px 25px rgba(0,0,0,0.15); }
        .no-selection { text-align:center; padding:80px 20px; color:#666; }
        .no-selection-icon { font-size:5em; margin-bottom:20px; }

        .employee-header { margin-bottom:30px; padding-bottom:20px;
                           border-bottom:2px solid #e0e0e0; }
        .employee-header h2 { color:#667eea; font-size:1.8em; margin-bottom:5px; }
        .employee-header p { color:#666; }

        .folders-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 20px;
        }
        .folder-card {
            background: #f8f9fa;
            padding: 30px 20px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
            text-align: center;
        }
        .folder-card:hover {
            background: #fff;
            border-color: #667eea;
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }
        .folder-icon {
            font-size: 3.5em;
            margin-bottom: 15px;
            display: block;
        }
        .folder-name {
            color: #333;
            font-size: 1.1em;
            font-weight: 600;
            margin-bottom: 8px;
        }
        .folder-count {
            color: #666;
            font-size: 0.9em;
        }

        .breadcrumb {
            background: #e7f3ff;
            padding: 12px 20px;
            border-radius: 8px;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        .breadcrumb a {
            color: #667eea;
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s;
        }
        .breadcrumb a:hover {
            color: #764ba2;
        }
        .breadcrumb span {
            color: #666;
        }

        .folder-contents {
            display: none;
        }
        .folder-contents.active {
            display: block;
        }

        .file-list {
            background: #fff;
            border-radius: 8px;
            overflow: hidden;
        }
        .file-item {
            padding: 15px 20px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.3s;
        }
        .file-item:hover {
            background: #f8f9fa;
        }
        .file-item:last-child {
            border-bottom: none;
        }
        .file-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .file-icon {
            font-size: 1.8em;
        }
        .file-details {
            display: flex;
            flex-direction: column;
        }
        .file-name {
            color: #333;
            font-weight: 600;
            margin-bottom: 3px;
        }
        .file-meta {
            color: #666;
            font-size: 0.85em;
        }
        .file-actions {
            display: flex;
            gap: 10px;
        }
        .action-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s;
        }
        .btn-view {
            background: #667eea;
            color: white;
        }
        .btn-download {
            background: #28a745;
            color: white;
        }
        .btn-delete {
            background: #dc3545;
            color: white;
        }
        .action-btn:hover {
            transform: scale(1.05);
        }

        .upload-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 25px;
            border: 2px dashed #667eea;
            text-align: center;
        }
        .upload-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: transform 0.2s;
        }
        .upload-btn:hover {
            transform: translateY(-2px);
        }

        .no-files {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        @media (max-width: 968px) {
            .content-area { grid-template-columns:1fr; }
            header { flex-direction:column; gap:15px; text-align:center; }
            .folders-grid { grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); }
            .controls { flex-direction:column; align-items:stretch; }
            .search-box { flex-direction:column; }
            .search-btn { width:100%; justify-content:center; }
        }
    </style>
</head>
<body>

    <!-- 1. FIREBASE FIRST -->
    <script type="module" src="employees-firebase.js"></script>

    <div class="container">
        <header>
            <div class="header-left">
                <h1>Mandatory Documents</h1>
                <p>Manage employee documentation</p>
            </div>
            <a href="index.html" class="back-btn">Back to Dashboard</a>
        </header>

        <!-- TOGGLES -->
        <div class="controls">
            <div class="toggle-group">
                <div class="toggle-switch">
                    <label class="switch">
                        <input type="checkbox" id="showActive" onchange="renderEmployeeList()">
                        <span class="slider"></span>
                    </label>
                    <span>Show Active</span>
                </div>
                <div class="toggle-switch">
                    <label class="switch">
                        <input type="checkbox" id="showLeavers" onchange="renderEmployeeList()">
                        <span class="slider"></span>
                    </label>
                    <span>Show Leavers</span>
                </div>
            </div>
            <div style="color:#666; font-size:0.9em;">
                Active: <strong id="activeCount">0</strong> | 
                Leavers: <strong id="leaverCount">0</strong>
            </div>
        </div>

        <div class="search-section">
            <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:15px;">
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="Search by employee name or ID..." onkeyup="if(event.key==='Enter') filterEmployees()">
                    <button class="search-btn" onclick="filterEmployees()">Search</button>
                </div>
            </div>
        </div>

        <div class="content-area">
            <div class="employee-list">
                <h2>Employees</h2>
                <div id="employeeListContainer">
                    <p style="color:#666; text-align:center;">Loading employees...</p>
                </div>
            </div>

            <div class="documents-area">
                <div id="noSelection" class="no-selection">
                    <div class="no-selection-icon">Folder</div>
                    <h3>No Employee Selected</h3>
                    <p>Please select an employee from the list to view their documents</p>
                </div>

                <div id="employeeDocuments" style="display: none;">
                    <div class="employee-header">
                        <h2 id="employeeName">Employee Name</h2>
                        <p id="employeeId">Employee ID</p>
                    </div>

                    <div id="foldersView" class="folders-view">
                        <div class="folders-grid">
                            <div class="folder-card" onclick="openFolder('disciplinaries')">
                                <span class="folder-icon">Warning</span>
                                <div class="folder-name">Disciplinaries</div>
                                <div class="folder-count" id="count-disciplinaries">0 documents</div>
                            </div>
                            <div class="folder-card" onclick="openFolder('one-to-ones')">
                                <span class="folder-icon">Chat</span>
                                <div class="folder-name">1-2-1's</div>
                                <div class="folder-count" id="count-one-to-ones">0 documents</div>
                            </div>
                            <div class="folder-card" onclick="openFolder('certificates')">
                                <span class="folder-icon">Certificate</span>
                                <div class="folder-name">Certificates</div>
                                <div class="folder-count" id="count-certificates">0 documents</div>
                            </div>
                            <div class="folder-card" onclick="openFolder('dbs-checks')">
                                <span class="folder-icon">Checkmark</span>
                                <div class="folder-name">DBS Checks</div>
                                <div class="folder-count" id="count-dbs-checks">0 documents</div>
                            </div>
                            <div class="folder-card" onclick="openFolder('miscellaneous')">
                                <span class="folder-icon">Clipboard</span>
                                <div class="folder-name">Miscellaneous</div>
                                <div class="folder-count" id="count-miscellaneous">0 documents</div>
                            </div>
                        </div>
                    </div>

                    <div id="folderContents" class="folder-contents">
                        <div class="breadcrumb">
                            <a href="#" onclick="closeFolderView(); return false;">Documents</a>
                            <span>›</span>
                            <span id="currentFolderName">Folder</span>
                        </div>

                        <div class="upload-section">
                            <input type="file" id="fileInput" style="display:none;" onchange="handleFileUpload(event)">
                            <button class="upload-btn" onclick="document.getElementById('fileInput').click()">Upload Document</button>
                        </div>

                        <div class="file-list" id="fileListContainer">
                            <div class="no-files">
                                <p>No documents in this folder</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 2. INLINE SCRIPT -->
    <script>
        let selectedEmployeeId = null;
        let currentFolder = null;

        // ────────────────────── 1. Render Employee List with Toggles ──────────────────────
        function renderEmployeeList() {
            const container = document.getElementById('employeeListContainer');
            const showActive = document.getElementById('showActive').checked;
            const showLeavers = document.getElementById('showLeavers').checked;

            const active = EMPLOYEES.data.filter(e => !e.dateLeft);
            const leavers = EMPLOYEES.data.filter(e => e.dateLeft);

            document.getElementById('activeCount').textContent = active.length;
            document.getElementById('leaverCount').textContent = leavers.length;

            let employeesToShow = [];
            if (showActive && showLeavers) employeesToShow = EMPLOYEES.data;
            else if (showActive) employeesToShow = active;
            else if (showLeavers) employeesToShow = leavers;

            if (!employeesToShow.length) {
                container.innerHTML = '<p style="color:#666; text-align:center;">No employees to show</p>';
                return;
            }

            container.innerHTML = '';
            employeesToShow.forEach(emp => {
                const isLeaver = !!emp.dateLeft;
                const item = document.createElement('div');
                item.className = `employee-item ${isLeaver ? 'leaver' : ''}`;
                item.onclick = () => selectEmployee(emp.id);
                item.innerHTML = `<strong>${emp.name}</strong><span>ID: ${emp.id}</span>`;
                container.appendChild(item);
            });
        }

        // ────────────────────── 2. Select Employee ──────────────────────
        function selectEmployee(id) {
            selectedEmployeeId = id;
            const emp = EMPLOYEES.data.find(e => e.id === id);
            if (!emp) return;

            document.querySelectorAll('.employee-item').forEach(i => i.classList.remove('active'));
            const activeItem = document.querySelector(`.employee-item[onclick="selectEmployee('${id}')"]`);
            if (activeItem) activeItem.classList.add('active');

            document.getElementById('noSelection').style.display = 'none';
            document.getElementById('employeeDocuments').style.display = 'block';
            document.getElementById('employeeName').textContent = emp.name;
            document.getElementById('employeeId').textContent = 'ID: ' + emp.id;

            closeFolderView();
            updateDocumentCounts(emp);
        }

        function updateDocumentCounts(emp) {
            const folders = ['disciplinaries', 'one-to-ones', 'certificates', 'dbs-checks', 'miscellaneous'];
            folders.forEach(f => {
                const docs = (emp.documents?.[f] || []).length;
                document.getElementById(`count-${f}`).textContent = `${docs} document${docs !== 1 ? 's' : ''}`;
            });
        }

        function openFolder(folderName) {
            if (!selectedEmployeeId) return;
            currentFolder = folderName;
            document.getElementById('foldersView').style.display = 'none';
            document.getElementById('folderContents').classList.add('active');

            const folderNames = {
                'disciplinaries': 'Disciplinaries',
                'one-to-ones': '1-2-1\'s',
                'certificates': 'Certificates',
                'dbs-checks': 'DBS Checks',
                'miscellaneous': 'Miscellaneous'
            };
            document.getElementById('currentFolderName').textContent = folderNames[folderName];

            loadDocuments(selectedEmployeeId, folderName);
        }

        function closeFolderView() {
            document.getElementById('foldersView').style.display = 'block';
            document.getElementById('folderContents').classList.remove('active');
            currentFolder = null;
        }

        function loadDocuments(empId, folderName) {
            const emp = EMPLOYEES.data.find(e => e.id === empId);
            const folderDocs = (emp.documents?.[folderName] || []) || [];
            const container = document.getElementById('fileListContainer');

            if (folderDocs.length === 0) {
                container.innerHTML = '<div class="no-files"><p>No documents in this folder</p></div>';
                return;
            }

            let html = '';
            folderDocs.forEach((doc, index) => {
                const date = new Date(doc.uploadedAt).toLocaleDateString('en-GB');
                html += `
                    <div class="file-item">
                        <div class="file-info">
                            <span class="file-icon">File</span>
                            <div class="file-details">
                                <span class="file-name">${doc.name}</span>
                                <span class="file-meta">${date} • ${doc.size || '—'}</span>
                            </div>
                        </div>
                        <div class="file-actions">
                            <button class="action-btn btn-view" onclick="viewDocument('${doc.url}')">View</button>
                            <button class="action-btn btn-download" onclick="downloadDocument('${doc.url}', '${doc.name}')">Download</button>
                            <button class="action-btn btn-delete" onclick="deleteDocument(${index})">Delete</button>
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file || !selectedEmployeeId || !currentFolder) return;

            const emp = EMPLOYEES.data.find(e => e.id === selectedEmployeeId);
            if (!emp.documents) emp.documents = {};
            if (!emp.documents[currentFolder]) emp.documents[currentFolder] = [];

            const reader = new FileReader();
            reader.onload = async function(e) {
                const base64 = e.target.result;
                const doc = {
                    name: file.name,
                    size: formatFileSize(file.size),
                    uploadedAt: new Date().toISOString(),
                    url: base64 // In real app: upload to Firebase Storage
                };

                emp.documents[currentFolder].push(doc);

                try {
                    await EMPLOYEES.update(emp.id, { documents: emp.documents });
                    alert("Document uploaded!");
                    loadDocuments(selectedEmployeeId, currentFolder);
                    updateDocumentCounts(emp);
                } catch (err) {
                    alert("Upload failed.");
                }
            };
            reader.readAsDataURL(file);
        }

        function viewDocument(url) {
            if (!url.startsWith('data:')) {
                alert("No preview available. Use Download.");
                return;
            }
            const win = window.open();
            win.document.write(`<iframe src="${url}" style="width:100%;height:100vh;border:none;"></iframe>`);
        }

        function downloadDocument(url, name) {
            const link = document.createElement('a');
            link.href = url;
            link.download = name;
            link.click();
        }

        async function deleteDocument(index) {
            if (!confirm("Delete this document?")) return;

            const emp = EMPLOYEES.data.find(e => e.id === selectedEmployeeId);
            emp.documents[currentFolder].splice(index, 1);

            try {
                await EMPLOYEES.update(emp.id, { documents: emp.documents });
                alert("Document deleted!");
                loadDocuments(selectedEmployeeId, currentFolder);
                updateDocumentCounts(emp);
            } catch (err) {
                alert("Delete failed.");
            }
        }

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            else if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
            else return (bytes / 1048576).toFixed(1) + ' MB';
        }

        function filterEmployees() {
            const term = document.getElementById('searchInput').value.trim().toLowerCase();
            document.querySelectorAll('.employee-item').forEach(item => {
                const text = item.textContent.toLowerCase();
                item.style.display = text.includes(term) ? 'block' : 'none';
            });
        }

        // ────────────────────── 3. ON LOAD ──────────────────────
        EMPLOYEES.onUpdate(() => {
            renderEmployeeList();
            if (selectedEmployeeId) {
                const emp = EMPLOYEES.data.find(e => e.id === selectedEmployeeId);
                if (emp) {
                    updateDocumentCounts(emp);
                    if (currentFolder) loadDocuments(selectedEmployeeId, currentFolder);
                }
            }
        });

        window.onload = function () {
            document.getElementById('employeeListContainer').innerHTML = '<p style="color:#666; text-align:center;">Loading employees...</p>';
            setTimeout(renderEmployeeList, 2000);
        };
    </script>
</body>
</html>
