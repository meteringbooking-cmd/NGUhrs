<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bonus Calculator | NGU-hrs</title>
    <script type="module" src="employees-firebase.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid #667eea;
        }
        h1 { color: #667eea; font-size: 2.2em; }
        .back-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            text-decoration: none;
        }
        .content-grid {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 30px;
        }
        .employee-list {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            max-height: 80vh;
            overflow-y: auto;
        }
        .employee-list h2 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.2em;
        }
        .employee-item {
            background: white;
            padding: 12px 15px;
            margin-bottom: 8px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            border-left: 4px solid #667eea;
        }
        .employee-item:hover {
            background: #e3f2fd;
            transform: translateX(5px);
        }
        .employee-item.active {
            background: linear-gradient(135deg, rgba(102,126,234,0.2), rgba(118,75,162,0.2));
            font-weight: 600;
        }
        .bonus-form {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 10px;
        }
        .form-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #667eea;
        }
        .form-header h2 {
            color: #667eea;
            font-size: 1.5em;
        }
        .bonus-total {
            background: #28a745;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 1.2em;
            font-weight: bold;
        }
        .week-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }
        .week-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .week-header h3 {
            color: #667eea;
            font-size: 1.1em;
        }
        .date-input {
            padding: 8px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 1em;
        }
        .job-quantity {
            margin-bottom: 15px;
        }
        .job-quantity label {
            display: block;
            color: #333;
            font-weight: 600;
            margin-bottom: 8px;
        }
        .job-quantity select {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 1em;
            width: 200px;
        }
        .jobs-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .job-select {
            background: white;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            text-align: center;
        }
        .job-select label {
            display: block;
            color: #666;
            font-size: 0.85em;
            margin-bottom: 8px;
        }
        .job-select select {
            width: 100%;
            padding: 8px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 0.95em;
        }
        .job-select.bonus {
            border-color: #28a745;
            background: #d4edda;
        }
        .calculate-btn {
            background: #28a745;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin-top: 20px;
        }
        .calculate-btn:hover {
            background: #218838;
        }
        .meter-count {
            color: #666;
            font-size: 0.9em;
            margin-top: 5px;
        }
        .empty-state {
            text-align: center;
            padding: 60px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div>
                <h1>üí∞ Bonus Calculator</h1>
                <p style="color: #666; margin-top: 5px;">Select employee and enter weekly job data</p>
            </div>
            <a href="index.html" class="back-btn">‚Üê Back</a>
        </header>

        <div class="content-grid">
            <div class="employee-list">
                <h2>Employees</h2>
                <div id="employeeListContainer">
                    <p style="color:#666; text-align:center;">Loading...</p>
                </div>
            </div>

            <div class="bonus-form">
                <div id="emptyState" class="empty-state">
                    <div style="font-size:4em;margin-bottom:20px;">üë§</div>
                    <h3>No Employee Selected</h3>
                    <p>Select an employee from the list to calculate bonus</p>
                </div>

                <div id="bonusFormContent" style="display:none;">
                    <div class="form-header">
                        <h2 id="selectedEmployeeName">Employee Name</h2>
                        <div class="bonus-total" id="totalBonus">¬£0.00</div>
                    </div>

                    <div id="weeksContainer"></div>

                    <button class="calculate-btn" onclick="calculateBonus()">Calculate Bonus</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let selectedEmployee = null;
        const meterValues = { 'Dual': 2, 'Single': 1, 'Comms': 1 };
        const bonusRates = { 'Dual': 80, 'Single': 50, 'Comms': 25 };

        function renderEmployeeList() {
            const container = document.getElementById('employeeListContainer');
            
            if (!window.EMPLOYEES || !window.EMPLOYEES.data) {
                setTimeout(renderEmployeeList, 500);
                return;
            }

            const active = window.EMPLOYEES.data
                .filter(e => !e.dateLeft)
                .sort((a, b) => a.name.localeCompare(b.name));

            if (!active.length) {
                container.innerHTML = '<p style="color:#666;">No employees found</p>';
                return;
            }

            container.innerHTML = active.map(emp => `
                <div class="employee-item" onclick="selectEmployee('${emp.id}')">
                    ${emp.name}
                </div>
            `).join('');
        }

        function selectEmployee(id) {
            selectedEmployee = window.EMPLOYEES.data.find(e => e.id === id);
            
            document.querySelectorAll('.employee-item').forEach(el => el.classList.remove('active'));
            event.target.classList.add('active');
            
            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('bonusFormContent').style.display = 'block';
            document.getElementById('selectedEmployeeName').textContent = selectedEmployee.name;
            
            generateWeeks();
        }

        function generateWeeks() {
            const container = document.getElementById('weeksContainer');
            let html = '';

            for (let week = 1; week <= 5; week++) {
                html += `
                    <div class="week-section">
                        <div class="week-header">
                            <h3>Week ${week}</h3>
                            <input type="date" class="date-input" id="date-week${week}" onchange="updateDates(${week})">
                        </div>
                        <div class="job-quantity">
                            <label for="qty-week${week}">Number of Jobs:</label>
                            <select id="qty-week${week}" onchange="generateJobSelectors(${week})">
                                <option value="0">0</option>
                                ${[...Array(10)].map((_, i) => `<option value="${i + 1}">${i + 1}</option>`).join('')}
                            </select>
                        </div>
                        <div class="jobs-container" id="jobs-week${week}"></div>
                    </div>`;
            }

            container.innerHTML = html;
        }

        function updateDates(weekNum) {
            if (weekNum === 1) {
                const startDate = new Date(document.getElementById(`date-week1`).value);
                
                for (let i = 2; i <= 5; i++) {
                    const nextDate = new Date(startDate);
                    nextDate.setDate(startDate.getDate() + (7 * (i - 1)));
                    document.getElementById(`date-week${i}`).value = nextDate.toISOString().split('T')[0];
                }
            }
        }

        function generateJobSelectors(weekNum) {
            const qty = parseInt(document.getElementById(`qty-week${weekNum}`).value);
            const container = document.getElementById(`jobs-week${weekNum}`);
            
            if (qty === 0) {
                container.innerHTML = '';
                return;
            }

            let html = '';
            for (let i = 1; i <= qty; i++) {
                html += `
                    <div class="job-select" id="job-week${weekNum}-${i}">
                        <label>Job ${i}</label>
                        <select id="type-week${weekNum}-${i}">
                            <option value="">Select...</option>
                            <option value="Dual">Dual (2 meters)</option>
                            <option value="Single">Single (1 meter)</option>
                            <option value="Comms">Comms (1 meter)</option>
                        </select>
                        <div class="meter-count" id="meter-week${weekNum}-${i}"></div>
                    </div>`;
            }
            
            container.innerHTML = html;
        }

        function calculateBonus() {
            let totalMeters = 0;
            let totalBonus = 0;
            let jobsProcessed = [];

            // Collect all jobs from all weeks
            for (let week = 1; week <= 5; week++) {
                const qty = parseInt(document.getElementById(`qty-week${week}`).value) || 0;
                
                for (let job = 1; job <= qty; job++) {
                    const type = document.getElementById(`type-week${week}-${job}`).value;
                    if (type) {
                        jobsProcessed.push({ week, job, type });
                    }
                }
            }

            // Process jobs in order and calculate bonus
            jobsProcessed.forEach(({ week, job, type }) => {
                const meters = meterValues[type];
                const previousTotal = totalMeters;
                totalMeters += meters;

                const jobElement = document.getElementById(`job-week${week}-${job}`);
                const meterElement = document.getElementById(`meter-week${week}-${job}`);

                if (totalMeters > 6) {
                    // Calculate partial bonus if job crosses 6 meter threshold
                    if (previousTotal < 6) {
                        const metersOverThreshold = totalMeters - 6;
                        const bonusPerMeter = bonusRates[type] / meters;
                        const bonusAmount = metersOverThreshold * bonusPerMeter;
                        totalBonus += bonusAmount;
                        
                        jobElement.classList.add('bonus');
                        meterElement.textContent = `${meters} meters (¬£${bonusAmount.toFixed(2)} bonus)`;
                    } else {
                        // Full bonus
                        const bonusAmount = bonusRates[type];
                        totalBonus += bonusAmount;
                        
                        jobElement.classList.add('bonus');
                        meterElement.textContent = `${meters} meters (¬£${bonusAmount.toFixed(2)} bonus)`;
                    }
                } else {
                    jobElement.classList.remove('bonus');
                    meterElement.textContent = `${meters} meters (no bonus yet)`;
                }
            });

            document.getElementById('totalBonus').textContent = `¬£${totalBonus.toFixed(2)}`;
        }

        window.onload = function() {
            if (window.EMPLOYEES) {
                window.EMPLOYEES.onUpdate(renderEmployeeList);
            }
            setTimeout(renderEmployeeList, 1000);
        };
    </script>
</body>
</html>
